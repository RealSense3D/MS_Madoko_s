<!DOCTYPE html>
<html>
<head>

<!-- madoko style -->
<link rel="stylesheet" type="text/css" href="styles/madoko.css">

<!-- main style -->
<link rel="stylesheet" type="text/css" href="styles/main.css">

<!-- Theme CSS must be loaded statically for now -->
<link rel="stylesheet" type="text/css" media="screen" href="lib/vs/editor/css/vs-dark-theme.css" />
<link rel="stylesheet" type="text/css" media="screen" href="lib/vs/editor/css/vs-theme.css" />

<!-- use the monaco loader to implement "require" -->
<script type="text/javascript" src="lib/vs/loader.js"></script>
<script>
  require.config({
    baseUrl: "lib"
  });
</script>

<!-- load jquery -->
<script type="text/javascript" src="lib/jquery-2.1.0.js"></script>

<!-- onedrive -->
<script src="//js.live.net/v5.0/wl.debug.js"></script>

<!-- install a handler that calls madoko to typeset -->
<script>
require(["std_core","std_path","webmain",
          "../scripts/util","../scripts/onedrive",
          "../scripts/ui",
          "vs/editor/editor.main"],
          function(stdcore,stdpath,madoko,util,onedrive,ui) 
{ 
  var docName     = "document.mdk";
  var docInfo     = {};
  var files       = {};
  var allowServer = true;

  var options = madoko.initialOptions();
  options.mathEmbedLimit = 256 * 1024;
  var view    = document.getElementById("view");
  var cons    = document.getElementById("koka-console-out");
  var editpane = document.getElementById("editorpane");
  var viewpane = document.getElementById("viewpane");
    
  var madokoWorker = new Worker("madoko-worker.js");
  

  var imageExts = ["",".jpg",".png",".gif",".svg"].join(";");
  function hasImageExt(fname) {
    return util.contains(imageExts,util.extname(fname));
  }

  var textExts = ["",".bib",".mdk",".md",".txt"].join(";");
  function hasTextExt(fname) {
    return util.contains(textExts,util.extname(fname));
  }


  // Called whenever the server needs to run madoko. The server can run:
  // - bibtex: generates a document.bbl file on the server with typeset bibliographies.
  //           for this to work, we need to send over a ".bib" file and potentially
  //           a bibliography style file ".bst".
  // - latex: formulas are typeset using latex. This generates a "document.dimx" file
  //           containing all typeset formulas. For this to work, we may need to 
  //           send extra style files (".sty") or class files (".cls"). 
  function serverRun() {
    if (!ui.allowServer()) return;

    var text = editor.getValue();
    // TODO: schedule run on server
    // send: document, and other files (like .bib and include files (but not images))    
    // receive back: document.dimx file (math content) and document.bbl (bibliography)
    var params = {};    
    params.docname = docName;
    params["/" + params.docname] = text;
    util.properties(files).forEach( function(fname) {
      if (hasTextExt(fname)) {
        params["/" + fname] = files[fname];
      }
    })

    $.post( "/rest/run", params, function(data,status,jqXHR) {
      util.message(data.stdout + data.stderr);
      util.properties(data).forEach(function(name) {
        if (name.substr(0,1) !== "/") return;
        //madoko.writeTextFile( name.substr(1), data[name] );
        util.message("write: " + name.substr(1) );
        files[name.substr(1)] = data[name];
      })
      //runMadoko(editor.getValue());
      ui.setStale();
    });
  }

  madokoWorker.addEventListener("message", function(ev) {
    var res = ev.data;
    if (res.message) {
      util.message(" " + res.message);
    }
    if (res.content) {
      view.innerHTML = res.content;
      //MathJax.Hub.Queue(["Typeset",MathJax.Hub,"view"]); // schedule mathjax    
    }
    if (res.runOnServer) {
      serverRun();
    }
    if (res.time) {
      util.message(" time: " + res.time + "ms" );
    }
    if (res.filesRead && res.filesRead.length > 0) {
      //message("files read:\n  " + res.filesRead.join("\n  "));
      res.filesRead.forEach( function(file) {
        if (!(files[file])) {
          if (hasImageExt(file)) {
            loadImage(file);
          }
          else if (hasTextExt(file)) {
            loadText(file);
          }
        }
      });
    }
    ui.completed(res.round);
  });

  
  function loadImage( fname ) {
    onedrive.getImageUrl( docInfo, fname, function(url) {
      options.imginfos = madoko.addImage(options.imginfos,fname,url);
    });
  }

  function loadText( fname ) {
    onedrive.getFileInfo( docInfo, fname, function(info) {
      onedrive.readFile( info, function(data) {
        console.log("read: " + fname);
        files[fname] = data;
      });
    });
  }

    
  var imgDir      = "img";
  
  function runMadoko(text,round) {
    util.message( "update " + round.toString() + " ..." );
    madokoWorker.postMessage( {
      content: text,
      name   : docName,
      options: options,
      round  : round,
      files  : files
    });
  }

  ui.init(runMadoko);
  util.message("ready.")  
});
</script>


</head>

<body>

<div id="initial" style="display:none; white-space:pre">
# An example   { #example }

Here is a famous equation:

~ Equation { #euler }
e = \lim_{n\to\infty} \left( 1 + \frac{1}{n} \right)^n
~

And we can refer to Equation [#euler] in Section [#example].

Or to a websites like [Bing] or [Google]

[bing]: http://www.bing.com "Bing it"
[google]: http://www.google.com 

```javascript 
function hi() {
  return "hello world";
}
```
</div>  
<div id="app">
<div id="menubar" class="toppane">
<!--
<img src="images/monarch-34px.png" id="logo"/>
insert image:
<input type="file" id="insertImages" name="files[]" title="Add images" accept="image/*"/>
-->
<img src="images/madoko-abslogo-xsmall.png" style="width:2em;vertical-align:-0.5ex;padding-right:2em"/>
<span id="onedrive-download" class="button" title="Load a document from OneDrive"><img src="images/onedrive-logo.png" style="width:2em; vertical-align:-1ex" /> load</span>
&nbsp;continuous:<input type="checkbox" id="checkContinuous" checked title="Update on each keypress"/>
&nbsp;enable server:<input type="checkbox" id="checkAllowServer" checked title="Use server to run LaTeX and BibTeX" />
</div>
<div id="editorpane" class="pane"><div id="editor"></div></div>
<div id="buttonbar-vertical">
<div id="button-editor-narrow" class="ibutton"></div>
<div id="button-editor-wide" class="ibutton"></div>
</div>
<div id="viewpane" class="pane madoko">
<div id="view"></div>
<div id="buttonbar-horizontal"><div id="button-updown" class="ibutton"></div></div>
<div id="koka-console"></div>
<div id="koka-console-out" class="monospace short"></div>
</div>
</div>
</body>
</html>
