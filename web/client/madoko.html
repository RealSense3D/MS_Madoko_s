<!DOCTYPE html>
<html>
<head>

<!-- madoko style -->
<link rel="stylesheet" type="text/css" href="../../styles/madoko.css">

<!-- monaco style -->
<style type="text/css">
  #editor {
    position: relative;
    border: 1px solid black;
    height: 60ex;
  }
</style>

<!-- Theme CSS must be loaded statically for now -->
<link rel="stylesheet" type="text/css" media="screen" href="lib/vs/editor/css/vs-theme.css" />

<!-- use the monaco loader to implement "require" -->
<script type="text/javascript" src="lib/vs/loader.js"></script>
<script>
  require.config({
    baseUrl: "lib"
  });
</script>

<!-- just mathjax stuff for dynamic math type setting.
     later we will use static images instead generated on the server
-->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]},
     TeX: { 
       Macros: { mathid: ['\\mathit{#1\\hspace{0.1ex}}',1], mathkw: ['\\mathsf{#1}',1],
                 mathspace: ['\\hspace{#1pt}\\hspace{#1pt}\\hspace{#1pt}',1], mathindent: ['\\hspace{#1ex}',1], mathbr: ['\\\\'],
               },

     }
  });
  MathJax.Hub.Register.StartupHook('TeX AMSmath Ready',function () { 
    MathJax.InputJax.TeX.Definitions.environment['mdMathprearray'] = ['AMSarray',null,null,null,'l','0em','0em'];
  });
</script>
<script type="text/javascript"
  src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<!-- install a handler that calls madoko to typeset -->
<script>
var languages = ["javascript","cpp","css","xml","markdown","coffeescript","java"
                ,"haskell","go","fsharp","r","cs","scala"]
                .map(function(name){ return "languages/" + name; });

require(["highlight.js",
         "std_core","std_path","storage","webmain",
         "vs/editor/editor.main"].concat(languages), 
          function(hljs,stdcore,stdpath,storage,madoko) 
{  
  var options = madoko.initialOptions();
  var images  = {};
  options.imginfos = images;

  var initial = document.getElementById("initial");
  var view = document.getElementById("view");

  var editor = Monaco.Editor.create(document.getElementById("editor"), {
    value: initial.innerText,
    mode: "text/x-web-markdown"
  });


  var text0 = "";
  var stale = true;

  var docName = "document";
  var imgDir  = "img";

  function serverRun() {
    var text = editor.getValue();
    // TODO: schedule run on server
    // send: document, and other files (like .bib and include files (but not images))    
    // receive back: document.dimx file (math content) and document.bbl (bibliography)
  }

  function update() {
    var text = editor.getValue();
    if (text != text0) {   // set stale but do not update yet (as long as the user types)
      stale = true;
      text0 = text;
    }
    else if (stale) {      // now update
      stale = false;
      madoko.markdown(docName,text,options, function(content,runOnServer,options1) {
        view.innerHTML = content;
        if (runOnServer) {
          serverRun();
        }
        MathJax.Hub.Queue(["Typeset",MathJax.Hub,"view"]); // schedule mathjax
      });
    }
  }

  function documentInsert( txt ) {
    var pos = editor.viewModel.cursors.lastCursorPositionChangedEvent.position;
    editor.model._insertText([],pos,txt);
    //var content = editor.getValue();
    //var pre = content.substr(0,i-1);
    //var post = content.substr(i);
    //editor.setValue( pre + txt + post );
  }

  function handleUploadImages(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    for (var i = 0, f; f = files[i]; i++) {
        // Only process image files.
        if (!f.type.match('image.*')) {
          continue;
        }
    
        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = (function(file) {
          return function(loadEvt) {
            var content = loadEvt.target.result;
            var fileName = imgDir + "/" + file.name;
            var name     = stdpath.stemname(file.name); 
            stdcore.println("image: " + fileName);
            options.imginfos = madoko.addImage(options.imginfos,fileName,content);
            documentInsert( "![" + name + "]\n\n[" + name + "]: " + fileName + ' "' + name + '"\n' );
            //madoko.writeTextFile(file.name,content);
          };
        })(f);

        // Read in the image file as a data URL.
        reader.readAsDataURL(f);
    }
  }


  update();
  setInterval(update, 500);
  document.getElementById('uploadImages').addEventListener('change', handleUploadImages, false);
});
</script>


<!-- styles -->
<style>
#view {
  border: 1px solid black;
  padding: 0.5em 1em;
  margin-top: 0.15em;
  height: 60ex;
}

td {
  vertical-align: top;
}

table#editview {
  width: 100%;
}

td#editor-cell, td#view-cell {
  width: 50%;
}

#koka-console {
  height: 10ex;
}
</style>
</head>

<body>

<p>
Insert image:
<input type="file" id="uploadImages" name="files[]" title="Add images" accept="image/*"></input>
</p>

<table id="editview">
<tr><td>Edit</td><td>View</td></tr>
<tr>
<td id="editor-cell">
<div id="editor"></div>
</td>
<td id="view-cell">
<div id="view">
</div>
</td>
</tr>
<td>
<div id="koka-console" class="monospace"></div>
</td>
</table>

<div id="initial" style="display:none">
Heading base: 2

# An example   { #example }

Here is a famous equation:

~ Equation { #euler }
e = \lim_{n\to\infty} \left( 1 + \frac{1}{n} \right)^n
~

And we can refer to Equation [#euler] in Section [#example].

Here is an image ![arborbw-small].

Or to a website like [bing](http://www.bing.com).

```javascript 
function hi() {
  return "hello world";
}
```
</div>  

</body>
</html>
