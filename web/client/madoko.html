<!DOCTYPE html>
<html>
<head>

<!-- madoko style -->
<link rel="stylesheet" type="text/css" href="styles/madoko.css">

<!-- Theme CSS must be loaded statically for now -->
<link rel="stylesheet" type="text/css" media="screen" href="lib/vs/editor/css/vs-dark-theme.css" />
<link rel="stylesheet" type="text/css" media="screen" href="lib/vs/editor/css/vs-theme.css" />

<!-- use the monaco loader to implement "require" -->
<script type="text/javascript" src="lib/vs/loader.js"></script>
<script>
  require.config({
    baseUrl: "lib"
  });
</script>

<!-- just mathjax stuff for dynamic math type setting.
     later we will use static images instead generated on the server
-->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]},
     TeX: { 
       Macros: { mathid: ['\\mathit{#1\\hspace{0.1ex}}',1], mathkw: ['\\mathsf{#1}',1],
                 mathspace: ['\\hspace{#1pt}\\hspace{#1pt}\\hspace{#1pt}',1], mathindent: ['\\hspace{#1ex}',1], mathbr: ['\\\\'],
               },

     }
  });
  MathJax.Hub.Register.StartupHook('TeX AMSmath Ready',function () { 
    MathJax.InputJax.TeX.Definitions.environment['mdMathprearray'] = ['AMSarray',null,null,null,'l','0em','0em'];
  });
</script>
<script type="text/javascript"
  src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- load jquery -->
<script type="text/javascript" src="lib/jquery-2.1.0.js"></script>

<!-- install a handler that calls madoko to typeset -->
<script>
require(["std_core","std_path","webmain","vs/editor/editor.main"],
          function(stdcore,stdpath,madoko) 
{ 
  var docName = "document";
  var files = {};

  // Get the properties of an object.
  function properties(obj) {
    var attrs = [];
    for (var key in obj) {
      if (obj.hasOwnProperty(key)) {
        attrs.push(key);
      }
    } 
    return attrs;
  }

  // extend target with all fields of obj.
  function extend(target, obj) {
    properties(obj).forEach( function(prop) {
      target[prop] = obj[prop];
    });
  }


  // Call for messages
  function message( txt ) {
    stdcore.println(txt);
  }

  // Called whenever the server needs to run madoko. The server can run:
  // - bibtex: generates a document.bbl file on the server with typeset bibliographies.
  //           for this to work, we need to send over a ".bib" file and potentially
  //           a bibliography style file ".bst".
  // - latex: formulas are typeset using latex. This generates a "document.dimx" file
  //           containing all typeset formulas. For this to work, we may need to 
  //           send extra style files (".sty") or class files (".cls"). 
  function serverRun() {
    var text = editor.getValue();
    // TODO: schedule run on server
    // send: document, and other files (like .bib and include files (but not images))    
    // receive back: document.dimx file (math content) and document.bbl (bibliography)
    var params = {};    
    params.docname = docName + ".mdk";
    params["/" + params.docname] = text;

    $.post( "rest/run", params, function(data,status,jqXHR) {
      message(data.stdout + data.stderr);
      properties(data).forEach(function(name) {
        if (name.substr(0,1) !== "/") return;
        //madoko.writeTextFile( name.substr(1), data[name] );
        message("write: " + name.substr(1) );
        files[name.substr(1)] = data[name];
      })
      //runMadoko(editor.getValue());
      stale = true;
    });
  }

  var options = madoko.initialOptions();
  options.mathEmbedLimit = 256 * 1024;
  var view    = document.getElementById("view");

  var madokoWorker = new Worker("madoko-worker.js");
  var lastRound = 0;
  madokoWorker.addEventListener("message", function(ev) {
    var res = ev.data;
    if (res.message) {
      message(" " + res.message);
    }
    if (res.content) {
      view.innerHTML = res.content;
      //MathJax.Hub.Queue(["Typeset",MathJax.Hub,"view"]); // schedule mathjax    
    }
    if (res.runOnServer) {
      serverRun();
    }
    if (res.time) {
      message(" time: " + res.time + "ms" );
    }
    lastRound = res.round;
  });
  

  var editor  = Monaco.Editor.create(document.getElementById("editor"), {
    value: document.getElementById("initial").textContent,
    mode: "text/x-web-markdown",
    theme: "vs-dark",
    lineNumbers: false
  });


  // TODO: fix this in the std core library
  stdcore.println("ready.")
  var cons = document.getElementById("koka-console-out");
  cons.wrap = "soft";
  cons.style.height = "100%";
  cons.style.whiteSpace = "pre-wrap";
  //cons.style.borderStyle = "none";
  //cons.style.height = "100%";
  //cons.style.marginTop = "1ex";
  cons.style.height = "98%";
  cons.style.margin = "1% 0ex";
  
    
  var text0 = "";     // text from the previous round
  var stale = true;   // is the view stale with respect to the current text?

  var imgDir  = "img";
  var refreshRate = 500;
  var refreshContinuous = true;
  
  function runMadoko(text) {
    round++;
    message( "update " + round.toString() + " ..." );
    madokoWorker.postMessage( {
      content: text,
      name   : docName,
      options: options,
      round  : round,
      files  : files
    });
  }

  // Called whenever the text buffer changes.
  // TODO: can we run this invoked by the editor instead of an interval?
  // and should we run in a worker perhaps?
  var round = lastRound;
  var staleTime = Date.now();
  function update() {
    var text = editor.getValue();
    if (text != text0) {   // set stale but do not update yet (as long as the user types)
      stale = true;      
      staleTime = Date.now();
      text0 = text;
      if (!refreshContinuous) return;
    }
    if (stale && (round == lastRound || Date.now() > staleTime + 5000)) {
      stale = false;
      runMadoko(text)
    }
  }

  // Insert some text in the document 
  function documentInsert( txt ) {
    var pos = editor.viewModel.cursors.lastCursorPositionChangedEvent.position;
    editor.model._insertText([],pos,txt);
  }

  // Called when a user selects an image to insert.
  function insertImages(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    for (var i = 0, f; f = files[i]; i++) {
        // Only process image files.
        if (!f.type.match('image.*')) {
          continue;
        }
    
        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = (function(file) {
          return function(loadEvt) {
            var content  = loadEvt.target.result;
            var fileName = imgDir + "/" + file.name;
            var name     = stdpath.stemname(file.name); 
            //stdcore.println("image: " + fileName);
            options.imginfos = madoko.addImage(options.imginfos,fileName,content);
            documentInsert( "![" + name + "]\n\n[" + name + "]: " + fileName + ' "' + name + '"\n' );
            //madoko.writeTextFile(file.name,content);
          };
        })(f);

        // Read in the image file as a data URL.
        reader.readAsDataURL(f);
    }
  }

  // Initialize
  setInterval(update, refreshRate);
  document.getElementById('insertImages').addEventListener('change', insertImages, false);
  document.getElementById('checkContinuous').onchange = function(ev) { 
    refreshContinuous = ev.target.checked; 
  };
});
</script>


<!-- styles -->
<style>
#editorpane {
  float: left;
  border: 1px solid black;
  margin: 0em;
  height: 92%;
  width:  50%;
}

#editor {
  height: 100%;
}

#viewpane {
  float: right;
  width: 49%;
  height: 92%;
}

#view {
  border: 1px solid black;
  height: 60%;
  margin: 0em;
  padding: 0em 1ex;
  overflow: scroll;
  background-color: white;
}

#koka-console {
  margin: 0em;
  height: 38%;
  padding: 0em; 
}

html,body,#app {
  height: 100%;
  padding: 0pt;
  margin: 0pt;
}

#app {
  padding: 0ex 1ex;
}


body {
  background-color: #3A4150;
  background-color: #FFFAF4;
}

#menubar {
  margin: 0ex 0ex 1ex 0ex;
  padding: 0em;
}

#logo {
  padding: 0pt; 
  width: 17px;
  vertical-align: bottom;
}

</style>
</head>

<body>

<div id="initial" style="display:none; white-space:pre">Heading base: 2

# An example   { #example }

Here is a famous equation:

~ Equation { #euler }
e = \lim_{n\to\infty} \left( 1 + \frac{1}{n} \right)^n
~

And we can refer to Equation [#euler] in Section [#example].

Here is an image ![arborbw-small].

Or to a website like [bing](http://www.bing.com).

```javascript 
function hi() {
  return "hello world";
}
```
</div>  
<div id="app">
<div id="menubar">
<img src="images/monarch-34px.png" id="logo"></img>
insert image:
<input type="file" id="insertImages" name="files[]" title="Add images" accept="image/*"/>
continuous:
<input type="checkbox" id="checkContinuous" checked=1 />
</div>
<div id="editorpane">
<div id="editor"></div>
</div>
<div id="viewpane">
<div id="view"></div>
<div id="koka-console" class="monospace"></div>
</div>
</div>
</body>
</html>
