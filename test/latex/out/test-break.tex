\documentclass{book}
% generated by Madoko, version 0.9.5-beta
%mdk-data-line={1}

\usepackage{madoko2}
\usepackage{lipsum}
\usepackage{pgfkeys}
\usepackage{tablefootnote}
\usepackage{mdframed}

\makeatletter

\providerobustcmd\unvcolorbox[2]{%
  \ifblank{#1}{\unvbox#2}{%
    \vbox{\offinterlineskip
      \hbox to \z@{\vbox to \z@{\noindent\color{#1}\vrule\@width\wd#2\@height\ht#2\@depth\dp#2\vss}\hss}%
      \unvbox#2%  
    }%
  }%
}

\providerobustcmd\eifstrequal[1]{%
  \expandafter\ifstrequal\expandafter{#1}%
}


\newif\ifpb@savefootnotes
\providecommand\pb@savefootnotes{%
  \ifpb@savefootnotes\else
    \let\footnote\tablefootnote
  \fi
   \pb@savefootnotestrue
}
\providecommand\pb@restorefootnotes{%   
  \ifpb@savefootnotes\else
    \tfn@tablefootnoteprintout
    \gdef\tfn@fnt{0}%
  \fi
} 

\newlength\pb@freevspace
\newrobustcmd*\pb@setfreevspace{%
  \bgroup\@nobreakfalse\addpenalty\z@\egroup%
  \penalty\@M\relax\vskip 2\baselineskip\relax%
  \penalty9999\relax\vskip -2\baselineskip\relax%
  \penalty9999%
  \ifdim\pagegoal=\maxdimen\relax%
    \pb@freevspace=\vsize%
  \else
    \pb@freevspace=\dimexpr\pagegoal-\pagetotal-\parskip\relax%
  \fi
  \pb@debug{free space: \the\pb@freevspace, in page: \the\textheight, vsize=\the\vsize}%
}

\newrobustcmd*\pb@ignorelastdescenders{%
  \par\strut\par%
  \unskip\unskip\setbox0=\lastbox
  \vspace*{\dimexpr\ht\strutbox-\baselineskip\relax}%
}

\newrobustcmd*\pb@ignorevbadness{%
   \edef\pb@currentvbadness{\the\vbadness}%
   \vbadness=\@M%
   \afterassignment\pb@restorevbadness
}
\newrobustcmd*\pb@restorevbadness{%
  \vbadness=\pb@currentvbadness\relax
}


\newcommand\pageboxbefore{}
\newcommand\pageboxafter{}

\newcommand\pb@lrbox[2]{%
 %\mdf@patchamsthm%patch amsthm
 \setbox#1\vbox\bgroup%
   \color@setgroup%
     \pb@inlrboxtrue
     %respect current margins by setting hsize to the linewidth
     \hsize#2\relax
     \columnwidth\hsize
     \textwidth\hsize
     \linewidth\hsize
     \@totalleftmargin\z@
     \leftmargin\z@
     \rightmargin\z@
     \leftskip\z@skip \rightskip\z@skip \@rightskip\z@skip%
     %\mdf@horizontalmargin@equation%
     %\columnwidth=\hsize%
     %\textwidth=\hsize%
     %\let\if@nobreak\iffalse%
     %\let\if@noskipsec\iffalse%
     %\let\par\@@par%
     %\let\-\@dischyph%
     %\let\'\@acci\let\`\@accii\let\=\@acciii%
     %\parindent\z@ \parskip\z@skip%
     %\linewidth\hsize%
     %\@totalleftmargin\z@%
     %\leftskip\z@skip \rightskip\z@skip \@rightskip\z@skip%
     %\parfillskip\@flushglue \lineskip\normallineskip%
     %\baselineskip\normalbaselineskip%
     %\let\\\@normalcr%
     \nofirstindent
     \nofirstparskip
}
\def\endpb@lrbox{\color@endgroup\egroup}




\newif\ifpb@verbose
\newrobustcmd\pb@debug[1]{
  \pb@typeout{debug: #1}
}
\newrobustcmd\pb@typeout[1]{
  \ifpb@verbose\typeout{pagebox: #1}\fi
}
\newrobustcmd\pb@warncannotsplit{%
  \PackageWarning{pagebox}{Cannot split box; it seems you are using a non splittable contents}%
}

\newlength\pb@singleextraheight
\newlength\pb@firstextraheight
\newlength\pb@middleextraheight
\newlength\pb@lastextraheight
\newlength\pb@splitminheight
\newlength\pb@height
\newlength\pb@width
\newif\ifpb@breakable
\newif\ifpb@inlrbox  % true if already inside a pagebox environment
\newcommand*\pb@valign{t}%

\setlength\pb@splitminheight{1.5\baselineskip}
\newsavebox\pb@headbox
\newsavebox\pb@savebox
\newsavebox\pb@mainbox

\newif\ifpbfirst
\newif\ifpbmiddle
\newif\ifpblast
\newif\ifpbsingle
\newif\ifpbfirstorsingle
\newif\ifpblastorsingle

\newrobustcmd*\pb@defbox[1]{%
  %\colorvbox{gainsboro}{#1}%
  \def\BOXCONTENT{\unvcolorbox{\pbbgcolor}{#1}}%
  \def\width{\wd#1}%
  \def\height{\ht#1}%
  \def\depth{\dp#1}%
  \let\totalheight\@ovri
  \totalheight\height
  \advance\totalheight\depth  
  %\pb@debug{define box: \the\width, \the\height, \the\depth}%
}


\newrobustcmd*\pb@renderdefault{%
  \BOXCONTENT
}

\newrobustcmd*\pb@single@[1]{%
  \begingroup\pbsingletrue\pbfirstorsingletrue\pblastorsingletrue
    \pb@defbox{#1}%
    \pb@single%
  \endgroup
}
\newrobustcmd*\pb@first@[1]{%
  \begingroup\pbfirsttrue\pbfirstorsingletrue
    \pb@defbox{#1}%
    \pb@first
    \vfill\eject
  \endgroup
}
\newrobustcmd*\pb@middle@[1]{%
  \begingroup\pbmiddletrue
    \pb@defbox{#1}%
    \pb@middle
    \vfill\eject
  \endgroup
}
\newrobustcmd*\pb@last@[1]{%
  \begingroup\pblasttrue\pblastorsingletrue
    \pb@defbox{#1}%
    \pb@last
  \endgroup
}


\newenvironment{pb@pagebox}{%
  \color@setgroup
  \pb@savefootnotes
  \colorlet{currentcolor}{.}%
  \pb@lrbox{\pb@mainbox}{\pb@width}%
  \pageboxbefore
}{%
  %\pb@ignorelastdescenders%
  \pageboxafter
  \par\unskip\ifvmode\nointerlineskip\hrule \@height\z@ \@width\hsize\fi%
  \endpb@lrbox%
  %\ifhmode\par\fi
  \ifdim\pb@height<0pt\else
    \pb@restrictheight
  \fi
  \ifpb@breakable
    \ifpb@inlrbox
      \pb@debug{disable breakable due to nesting}%
      \pb@breakablefalse
    \fi
  \fi
  \pb@typeset
  \pb@restorefootnotes
  \color@endgroup
}


\newcommand\pb@restrictheight{%
  \pb@typeout{restrict height to \the\pb@height}%
  \setlength\pb@splitheight{\dimexpr\pb@height - \pb@singleextraheight\relax}%
  \pb@splitbox
  \ifdim\ht\pb@headbox=0pt\relax
    %split failed.. do nothing
    \pb@debug{could not restrict height}%
  \else
    % store splitted off content in the mainbox (and discard the rest)
    \setbox\pb@mainbox\vbox{\unvbox\pb@headbox}%
    \pb@debug{restricted height to \the\ht\pb@mainbox}%
  \fi
  \if\pb@valign b\relax      
    \setbox\pb@mainbox=\vbox{\hbox{\vbox to \pb@splitheight{\vfill\unvbox\pb@mainbox}}}%
  \else\if\pb@valign c\relax      
    \setbox\pb@mainbox=\vbox{\hbox{\vbox to \pb@splitheight{\vfill\unvbox\pb@mainbox\vfill}}}%
  \else % default is top
    \setbox\pb@mainbox=\vbox{\hbox{\vbox to \pb@splitheight{\unvbox\pb@mainbox\vfill}}}%
  \fi\fi
}

\newlength\pb@neededvspace
\newcommand\pb@typeset[1][0pt]{%
  \ifpb@breakable
    \pb@setfreevspace
    \setlength\pb@neededvspace{\dimexpr\ht\pb@mainbox+\dp\pb@mainbox+\pb@singleextraheight\relax}%
    \pb@debug{needed: \the\pb@neededvspace, available: \the\pb@freevspace}%
    \ifdim\pb@neededvspace<\pb@freevspace\relax
      \pb@single@{\pb@mainbox}%
    \else
      \pb@typeout{pagebox needs splitting}%
      \setlength\pb@splitheight{\dimexpr\pb@freevspace-\pb@firstextraheight\relax}%
      \pb@splitbox
      \ifdim\ht\pb@headbox=0pt\relax
        % failed to split
        \ifdim\dimexpr\pb@freevspace + #1\relax<\textheight\relax % test if we where at a fresh page.. (and prevent infinite recursion)
          \pb@debug{failed to split the box, inserting a page break}%
          \hrule \@height\z@ \@width\hsize
          \vfill\eject 
          \pb@typeset[\textheight]%
        \else
          % on a fresh page we should not fail anymore.. just output as is..
          % pb@warncannotsplit
          \pb@single@{\pb@mainbox}%
        \fi
      \else
        % first part success
        \pb@typeout{first part splitted}%
        \pb@first@{\pb@headbox}%
        \pb@typesetrest
      \fi
    \fi
  \else
    \pb@debug{unbreakable box}%
    \pb@single@{\pb@mainbox}% always directly output an unbreakable box
  \fi
}

\newcommand\pb@typesetrest{%
  \pb@setfreevspace%
  \setlength\pb@neededvspace{\dimexpr\ht\pb@mainbox+\dp\pb@mainbox+\pb@lastextraheight\relax}%
  \ifdim\pb@neededvspace<\pb@freevspace\relax
    \pb@typeout{output last part of box}%
    \pb@last@{\pb@mainbox}%
  \else
    \pb@debug{split box further}%
    \setlength\pb@splitheight{\dimexpr\pb@freevspace-\pb@middleextraheight\relax}%
    \pb@splitbox
    \ifdim\ht\pb@headbox=0pt\relax
      % failed to split
      \pb@typeout{failed to split box!}%
      \pb@last@{\pb@mainbox}%
    \else
      % middle part success
      \pb@typeout{output middle part of box}%
      \pb@middle@{\pb@headbox}%
      \pb@typesetrest % continue the iteration...
    \fi
  \fi
}

\newlength\pb@splitheight
\newlength\pb@insurance
\setlength\pb@insurance{1pt}

% expects split target height in pb@splitheight, and splits off the start of pb@mainbox to pb@headbox
\newcommand\pb@splitbox[1][0pt]{
  \ifdim\dimexpr\ht\pb@mainbox + \dp\pb@mainbox\relax>\pb@splitheight\relax
    % the main box is larger than our target split height..
    \ifdim\pb@splitminheight>\pb@splitheight\relax
      % not enough space to bother
      \pb@typeout{not enough space on page for a split}%
      \setbox\pb@headbox=\vbox{}% empty head
    \else
      % try a split; lower the split height a bit so we are sure to fit
      \advance\pb@splitheight -\pb@insurance\relax
      \pb@debug{split: \the\pb@splitheight, from \the\dimexpr\ht\pb@mainbox + \dp\pb@mainbox\relax}%
      \setbox\pb@savebox=\vbox{\unvcopy\pb@mainbox}% save original  
      \pb@trysplit{\pb@splitheight}%
      \ifdim\dimexpr\ht\pb@headbox + \dp\pb@headbox>\pb@splitheight\relax
        % too big, bad split. Try other splits.. iterate 100 times with 1pt less before giving up
        \dimen@=\pb@splitheight\relax%
        \@tempcnta=\z@\relax%
        \loop
        \ifdim\dimexpr\ht\pb@headbox+\dp\pb@headbox\relax>\pb@splitheight\relax
          \advance\dimen@ by -\p@\relax% try a slightly smaller height..
          \advance\@tempcnta by \@ne\relax
          \pb@ignorevbadness
          \setbox\pb@mainbox=\vbox{\unvcopy\pb@savebox}% restore
          \pb@trysplit{\dimen@}%
          \ifdim\dimen@<\pb@splitminheight\relax \pb@splitstop\fi% don't try to split too small
          \ifnum\@tempcnta>100\relax \pb@splitstop\fi% and not more than 100 attempts
        \repeat%
      \fi
    \fi
  \else
    % mainbox fits in our target pb@splitheight
    \pb@headbox=\vbox{\unvbox\pb@mainbox}%
    \pb@mainbox=\vbox{}%
  \fi
}

\newcommand\pb@splitstop{%
  \pb@typeout{cannot find a good split}%
  \let\iterate\relax
  \pb@warncannotsplit
  \setbox\pb@mainbox=\vbox{\unvcopy\pb@savebox}% restore      
  \setbox\pb@headbox=\vbox{}% empty head    
}

\newcommand\pb@trysplit[1]{% try to split at given height
  \pb@typeout{try to split at: \the\dimexpr #1\relax}%
  \pb@ignorevbadness  
  \typeoutinfo{split}%    
  \setbox\pb@headbox=\vsplit\pb@mainbox to #1\relax%
  \setbox\pb@headbox=\vbox{\unvbox\pb@headbox}%
  \setbox\pb@mainbox=\vbox{\unvbox\pb@mainbox}%  
}

\newcommand\typeoutinfo[1]{
  \pb@debug{msg #1: \the\linewidth, \the\@totalleftmargin, \the\leftmargin, \the\textwidth, \the\hsize.}%
}

\newenvironment{pagebox}[1][]{%
  \pgfqkeys{/pagebox}{%
    extra/single/.code={\setlength\pb@singleextraheight{##1}},
    extra/first/.code={\setlength\pb@firstextraheight{##1}},
    extra/middle/.code={\setlength\pb@middleextraheight{##1}},
    extra/last/.code={\setlength\pb@lastextraheight{##1}},
    extra/split/.code={\setlength\pb@splitminheight{##1}},
    extra/split={1.5\baselineskip},
    extra/sides/.initial={0pt},
    extra/.style={extra/single=##1, extra/first=##1, extra/middle=##1, extra/last=##1, extra/sides=##1},%
    extra=0pt,
  }%
  \pgfqkeys{/pagebox}{%
    render/single/.code={\def\pb@single{##1}},
    render/first/.code={\def\pb@first{##1}},
    render/middle/.code={\def\pb@middle{##1}},
    render/last/.code={\def\pb@last{##1}},
    render/.style={render/single=##1, render/first=##1, render/middle=##1, render/last=##1},
    render=\pb@renderdefault
  }%%
  \pgfqkeys{/pagebox}{%
    height/.code={\setlength\pb@height{##1}},
    height=-1sp,
    height/align/.is choice,
    height/align/top/.code={\def\pb@valign{t}},
    height/align/middle/.code={\def\pb@valign{c}},
    height/align/center/.code={\def\pb@valign{c}},
    height/align/bottom/.code={\def\pb@valign{b}},
    height/align=top,
    width/.code={\setlength\pb@width{##1}},
    width=\linewidth,
    bgcolor/.code={\eifstrequal{##1}{transparent}{\def\pbbgcolor{}}{\def\pbbgcolor{##1}}},
    bgcolor={transparent},
    breakable/.is if=pb@breakable,
    breakable=true,
    verbose/.is if=pb@verbose,
    verbose=true,
  }%
  \pgfqkeys{/pagebox}{#1}%
  \addtolength\pb@width{-\pgfkeysvalueof{/pagebox/extra/sides}}%
  \typeout{sides: \pgfkeysvalueof{/pagebox/extra/sides}, linewidth: \the\linewidth, width: \the\pb@width}%
  \begin{pb@pagebox}%
}{\end{pb@pagebox}}



\newrobustcmd*\fboxfirst{%
  %\vbox{\offinterlineskip\hrule height 0.4pt\relax\noindent\usebox#1}
  \noindent\BOXCONTENT%
}
\newrobustcmd*\fboxmiddle{%
  \noindent\BOXCONTENT%
}
\newrobustcmd*\fboxlast{%
  \noindent\BOXCONTENT%
}
\newrobustcmd*\fboxsingle{%
  \begingroup
  \fboxsep\z@
  \noindent\colorbox{floralwhite}{%
  \fboxsep3pt%    
  \raise\dimexpr0.7\baselineskip+\fboxsep+\fboxrule\vtop{%
    \offinterlineskip
    \ifpbfirstorsingle{\color{currentcolor}\hrule height \fboxrule}\fi%
    \hbox{%
      {\color{currentcolor}\vrule width \fboxrule}%
      \hskip\fboxsep
      \vbox{\offinterlineskip
        \ifpbfirstorsingle\vskip\fboxsep\fi
        \BOXCONTENT%
        \ifpblastorsingle\vskip\fboxsep\fi
      }%
      \hskip\fboxsep      
      {\color{currentcolor}\vrule width \fboxrule}%
    }%
    \ifpblastorsingle{\color{currentcolor}\hrule height \fboxrule}\fi%
  }%
  }%
  \endgroup
}


\makeatother

\parskip=0ex %\parindent=0pt


\begin{document}

Next

\newlength\fboxextra
\setlength\fboxextra{\dimexpr\fboxsep+\fboxrule\relax}
\begin{pagebox}[render=\fboxsingle,extra=2\fboxextra,extra/first=\fboxextra,extra/last=\fboxextra,extra/middle=0pt,bgcolor=floralwhite]

Testign test
\begin{pagebox}[render=\fboxsingle,extra=2\fboxextra,bgcolor=gainsboro,height=4.8cm,height/align=top,width=5cm]
\centering
\lipsum[1-2]
\end{pagebox}


\begin{pagebox}[render=\fboxsingle,extra=2\fboxextra,bgcolor=gainsboro,height=4.8cm,height/align=top]
\centering
\lipsum[1-2]
\end{pagebox}

\lipsum[2]

\lipsum[3-4]

{\color{blue}
test\footnote{test}

\begin{equation}
e = mc^2
\end{equation}

\lipsum[5-16]}

other.
\end{pagebox}

next, mdframed:

\begin{mdframed}[linewidth=0.4pt]

\lipsum[1-4]

{\color{blue}
test\footnote{test}


\lipsum[5-16]}

other.
\end{mdframed}

The end.

\end{document}
