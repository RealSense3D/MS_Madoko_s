\documentclass{book}
% generated by Madoko, version 0.9.5-beta
%mdk-data-line={1}

%\usepackage{madoko2}
\usepackage{xcolor}
\usepackage{pgfkeys}
\usepackage{pgffor}
\usepackage{tablefootnote}
%\usepackage{mdframed}
\usepackage{lipsum}

\parskip=0ex %\parindent=0pt

% Define basic CSS colors
\providecolor{red}{HTML}{FF0000}
\providecolor{lime}{HTML}{00FF00}
\providecolor{blue}{HTML}{0000FF}

\providecolor{yellow}{HTML}{FFFF00}
\providecolor{cyan}{HTML}{00FFFF}
\providecolor{magenta}{HTML}{FF00FF}

\providecolor{navy}{HTML}{000080}
\providecolor{maroon}{HTML}{800000}
\providecolor{green}{HTML}{008000}

\providecolor{teal}{HTML}{008080}
\providecolor{purple}{HTML}{800080}
\providecolor{olive}{HTML}{808000}

\providecolor{black}{HTML}{000000}
\providecolor{dimgray}{HTML}{696969}
\providecolor{gray}{HTML}{808080}
\providecolor{darkgray}{HTML}{A9A9A9}
\providecolor{silver}{HTML}{C0C0C0}
\providecolor{lightgray}{HTML}{D3D3D3}
\providecolor{gainsboro}{HTML}{DCDCDC}
\providecolor{floralwhite}{HTML}{FFFAF0}
\providecolor{ivory}{HTML}{FFFFF0}
\providecolor{white}{HTML}{FFFFFF}
\providecolor{transparent}{named}{white}

\makeatletter


% --------------------------------------------------------
% Extensions to etoolbox
% --------------------------------------------------------

% expand an argument and test for string equality
%
% \eifstrequal{<unexpanded s>}{<string>}{<equalcode>}{<unequalcode>}
\providecommand\eifstrequal[1]{%
  \expandafter\ifstrequal\expandafter{#1}%
}

\providecommand\eifblank[1]{%
  \protected@edef\@ifblankarg{#1}%
  \expandafter\ifblank\expandafter{\@ifblankarg}%
}

\providecommand\ontoggle[2]{%
  \iftoggle{#1}{#2}{}%
}
\providecommand\ontogglefalse[2]{%
  \iftoggle{#1}{}{#2}%
}

\providecommand\providelength[1]{% 
  \ifdef{#1}{}{\newlength#1}%
}

\providecommand\csnewlength[1]{%
  \expandafter\newlength\csname #1\endcsname%
}
\providecommand\csprovidelength[1]{%
  \ifcsdef{#1}{}{\expandafter\newlength\csname #1\endcsname}%
}
\providecommand\cssetlength[2]{%
  \expandafter\setlength\csname #1\endcsname{#2}%
}

% --------------------------------------------------------
% Extensions to pgfkeys
% --------------------------------------------------------
\newcommand\headof[2]{%
  \let#2\relax%
  \foreach\x in {#1} {%
    \xdef#2{\x}%    
    \breakforeach
  }%
}

\def\pgfkeyssetvalue@#1#2{%
  \pgfkeyssetvalue{#2}{#1}%
}

\pgfkeys{/handlers/.is oneof/.code=%
  \headof{#1}\@head%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@oneof{##1}{\pgfkeyscurrentpath}{#1},%
    \pgfkeyscurrentpath=\@head,%
  }%
}
\def\pgf@handle@oneof#1#2#3{%
  \expandafter\pgf@handle@oneof@\expandafter{#1}{#2}{#3}%
}
\def\pgf@handle@oneof@#1#2#3{%
  \typeout{oneof: #2=#1 in #3}%
  \let\pgf@oneof\relax%
  \foreach\x in {#3} {%
    \eifstrequal{\x}{#1}{%
      \xdef\pgf@oneof{\x}%
      \breakforeach
    }{}%
  }%
  \ifx\pgf@oneof\relax
    \pgfkeysvalueof{/errors/unknown oneof value/.@cmd}{#2={#3}}{#1}\pgfeov%
  \else
    \pgfkeyssetvalue{#2}{#1}%
  \fi
}
\pgfkeys{/errors/unknown oneof value/.code 2 args=\pgfkeys@error{%
  Choice '#2' unknown in key #1. I am going to ignore this key.%
}}

\pgfkeys{/handlers/.is toggle/.code=%
  \providetoggle{\pgfkeyscurrentpath}%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@toggle{##1}{\pgfkeyscurrentpath},%
    \pgfkeyscurrentpath/.default=true,%
    \pgfkeyscurrentpath=#1,%
  }%
  %\notblank{#1}{\pgf@handle@toggle{#1}}%
}
\def\pgf@handle@toggle#1#2{%
  \lb@debug{toggle: #2=#1}%
  \ifcsdef{toggle#1}%
    {\csuse{toggle#1}{#2}\pgfkeyssetvalue{#2}{#1}}%
    {\pgfkeysvalueof{/errors-boolean expected/.@cmd}\pgfkeyscurrentkey{#1}\pgfeov}%
}

\pgfkeys{/handlers/.is color/.code=\pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@color{##1}{\pgfkeyscurrentpath},%
    \pgfkeyscurrentpath=#1,
  }%
}
\def\pgf@handle@color#1#2{%
  \lb@debug{color: #2=#1}%
  \pgfkeyssetvalue{#2}{#1}%
  \eifblank{#1}%
    {\colorlet{#2}{.}}%
    {\colorlet{#2}{#1}}%
}

\pgfkeys{/handlers/.is dimexpr/.code=%
  \csprovidelength{length@\pgfkeyscurrentpath}%
  \expandafter\pgfkeyssetvalue@\csname length@\pgfkeyscurrentpath\endcsname{\pgfkeyscurrentpath}%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@dimexpr{##1}{\pgfkeyscurrentpath},%
    \pgfkeyscurrentpath=#1,%
  }%
}
\def\pgf@handle@dimexpr#1#2{%
  \lb@debug{dimexpr: #2=#1 == \the\dimexpr#1\relax}%  
  \cssetlength{length@#2}{\dimexpr#1\relax}%
}

\newcommand\letvalueof{\pgfkeysgetvalue}%
\newcommand\valueof{\pgfkeysvalueof}%
\newcommand\colorof[1]{%
  \letvalueof{#1}\reserved@a
  \eifblank{\reserved@a}{}{\color{#1}}%
}
\newcommand\ifvalueofequal[1]{%
  \letvalueof{#1}\reserved@a
  \eifstrequal{\reserved@a}%
}

% --------------------------------------------------------
% Utilities for LaTeX internals
% --------------------------------------------------------

% Suppress the indentation on the following paragraph
\providecommand\nofirstindent{\@afterindentfalse\@afterheading}

% Suppress the paragraph skip on the following paragraph
\providecommand\nofirstparskip{\addvskip{-\parskip}}

% In contrast to addvspace, addvskip is not suppressed in a minipage
\providecommand\addvskip[1]{%
  \ifvmode
    \ifdim\lastskip=\z@
      \vskip #1\relax
    \else
      \@tempskipb#1\relax\@xaddvskip
    \fi
  \else\@noitemerr\fi
}


% unvbox a box, and return a vbox with a given background color
% \unvcolorbox{<colorspec>}{<vboxname>}
\newcommand\unvcolorbox[2]{%
  \eifblank{#1}{\vbox{\unvbox#2}}{%
    \lb@debug{vcolorbox: #1}%
    \vbox{\offinterlineskip
      \hbox to \z@{\vbox to \z@{\noindent\color{#1}\vrule\@width\wd#2\@height\ht#2\@depth\dp#2\vss}\hss}%
      \unvbox#2%  
    }%
  }%
}

% create a vbox with a given background color 
\newcommand\vcolorbox[2]{%
  \eifblank{#1}{\vbox{#2}}{%
    \setbox\z@=\vbox{#2}\relax
    \unvcolorbox{#1}{\z@}%
  }%
}%


% --------------------------------------------------------
% Capturing footnotes
% --------------------------------------------------------

% To catch the footnotes in a box and output them afterwards
% we rely on the tablefootnote package. 
% \lb@savefootnotes saves footnotes in the environment
% \lb@restorefoontes is called after the environment to inject them into the normal footnotes
\newif\iflb@savefootnotes
\providecommand\lb@savefootnotes{%
  \iflb@savefootnotes\else
    \let\footnote\tablefootnote
  \fi
   \lb@savefootnotestrue
}
\providecommand\lb@restorefootnotes{%   
  \iflb@savefootnotes\else
    \tfn@tablefootnoteprintout
    \gdef\tfn@fnt{0}%
  \fi
} 

% --------------------------------------------------------
% The following macros come from mdframed
% --------------------------------------------------------

% Determine the amount of free space left on the current page
\newlength\lb@freevspace
\newrobustcmd*\lb@setfreevspace{%
  \bgroup\@nobreakfalse\addpenalty\z@\egroup%
  \penalty\@M\relax\vskip 2\baselineskip\relax%
  \penalty9999\relax\vskip -2\baselineskip\relax%
  \penalty9999%
  \ifdim\pagegoal=\maxdimen\relax%
    \lb@freevspace=\vsize%
  \else
    \lb@freevspace=\dimexpr\pagegoal-\pagetotal-\parskip\relax%
  \fi
  \lb@debug{free space: \the\lb@freevspace, in page: \the\textheight, vsize=\the\vsize}%
}

% Insert negative vspace of the length of the current descender
\def\lb@descenders{0pt}%
\newrobustcmd*\lb@ignorelastdescenders{%
  \par\strut\par%
  \unskip\unskip\setbox0=\lastbox
  \global\edef\lb@descenders{\the\dimexpr\baselineskip-\ht\strutbox\relax}%
  \vspace*{\dimexpr-\lb@descenders\relax}%
  %\vspace*{\lb@descenders}%
}

% Suppress overfull-underfull vbox messages
\newrobustcmd*\lb@ignorevbadness{%
   \edef\lb@currentvbadness{\the\vbadness}%
   \vbadness=\@M%
   \afterassignment\lb@restorevbadness
}
\newrobustcmd*\lb@restorevbadness{%
  \vbadness=\lb@currentvbadness\relax
}


% --------------------------------------------------------
% The 'long vbox' (lvbox) environment collects long material 
% into a long \vbox, instead of a \hbox like a lrbox in latex.
% The collected box can contain any box, minipage, lrbox, fbox etc,
% but not outer-par material like a figure. Footnotes can be
% dealt with useing lb@savefootnotes.
%
% The material is typeset in a \vbox according to a given width.
% inside the environment, the boolean 'inlvbox' is true.
%
% \begin{tdbox}{<boxname>}{<width>}
% --------------------------------------------------------

\newif\ifinlvbox
\newcommand\lvbox[2]{%
 \setbox#1\vbox\bgroup
   \begingroup
   \inlvboxtrue
   \hsize#2\relax
   \columnwidth\hsize
   \textwidth\hsize
   \linewidth\hsize
   \@totalleftmargin\z@ \leftmargin\z@ \rightmargin\z@
   \leftskip\z@skip \rightskip\z@skip \@rightskip\z@skip
   \nofirstindent
   %\nofirstparskip
}
\def\endlvbox{\endgroup\egroup}


% --------------------------------------------------------
% Debugging
% --------------------------------------------------------

\newrobustcmd\lb@debug[1]{%
  \ontoggle{/longbox/debug}{\typeout{longbox debug: #1}}%
}
\newrobustcmd\lb@typeout[1]{%
  \ontoggle{/longbox/verbose}{\typeout{longbox: #1}}%
}
\newrobustcmd\lb@warncannotsplit{%
  \PackageWarning{longbox}{Cannot split box; it seems you are using a non-splittable contents.}%
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newsavebox\lb@headbox
\newsavebox\lb@savebox
\newsavebox\lb@mainbox

% --------------------------------------------------------
%
% --------------------------------------------------------

\newrobustcmd*\lb@defbox[1]{%
  \ifvalueofequal{/longbox/valign}{top}%
    {\setbox#1=\vtop{\unvbox#1}}%
  {\ifvalueofequal{/longbox/valign}{middle}%
    {\setbox#1=\vbox{\hbox{\lower \dimexpr(\dp#1 + \ht#1)/2\relax\vbox{\unvbox#1}}}}%    
    {}}
    %{\setbox#1=\vbox{\hbox{\lower \dimexpr\lb@descenders\relax\vbox{\unvbox#1}}}}}%    
  \pgfkeys{%
    /longbox/part-width=\wd#1,%
    /longbox/part-height=\dp#1 + \ht#1,%
    /longbox/part-depth=\dp#1,%
    /longbox/part-content=\unvcolorbox{\valueof{/longbox/background-color}}{#1},%
  }%
}


\newrobustcmd*\lb@renderdefault{%
  \valueof{/longbox/part-content}%
}

\newrobustcmd*\lb@single@[1]{%
  \begingroup
    \toggletrue{/longbox/part-issingle}%
    \toggletrue{/longbox/part-needtop}%
    \toggletrue{/longbox/part-needbottom}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-single}%
  \endgroup
}
\newrobustcmd*\lb@first@[1]{%
  \begingroup
    \toggletrue{/longbox/part-isfirst}%
    \toggletrue{/longbox/part-needtop}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-first}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@middle@[1]{%
  \begingroup
    \toggletrue{/longbox/part-ismiddle}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-middle}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@last@[1]{%
  \begingroup
    \toggletrue{/longbox/part-islast}%
    \toggletrue{/longbox/part-needbottom}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-last}%
  \endgroup
}

% --------------------------------------------------------
%
% --------------------------------------------------------
\newenvironment{lb@longbox}{%
  \begingroup
  \lb@savefootnotes
  %\colorof{/longbox/color}%
  \lvbox{\lb@mainbox}{\valueof{/longbox/width}}%
  \valueof{/longbox/insert-before}% 
}{%
  \lb@ignorelastdescenders%
  \valueof{/longbox/insert-after}%
  \par\unskip\ifvmode\nointerlineskip\hrule \@height\z@ \@width\hsize\fi%
  \endlvbox%  
  \lb@debug{initial lvbox: \the\dp\lb@mainbox, \the\ht\lb@mainbox, \the\wd\lb@mainbox, \lb@descenders}%
  \lb@processbox
  \endgroup
}

\newcommand\@lbox[1]{%  
  \longboxadjustkeys
  \leavevmode
  \setbox\lb@mainbox=\hbox{%
    \color@begingroup
    \valueof{/longbox/insert-before}%
    #1%
    \valueof{/longbox/insert-before}%
    \color@endgroup
  }%
  \lb@debug{initial lbox: \the\dp\lb@mainbox, \the\ht\lb@mainbox, \the\wd\lb@mainbox}%
  \ifdim\valueof{/longbox/width}<0pt\relax
    \setbox\lb@mainbox=\vbox{\hbox{\unhbox\lb@mainbox}}%
  \else
    \setbox\lb@mainbox=\vbox{\hbox to \valueof{/longbox/width}{\unhbox\lb@mainbox}}%
  \fi
  \lb@processbox
  %\lb@single@{\lb@mainbox}%
}

\newcommand\lb@processbox{%
  \ifdim\valueof{/longbox/height}<0pt\relax\else
    \lb@restrictheight
  \fi
  \ifinlvbox
    \iftoggle{/longbox/breakable}{%
      \lb@debug{disable breakable due to nesting of long-boxes}%
      \togglefalse{/longbox/breakable}%
    }{}%
  \fi
  \ifhmode\lb@single@{\lb@mainbox}\else
    \lb@typeset
    \lb@restorefootnotes
  \fi
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newcommand\lb@restrictheight{%
  \lb@typeout{restrict height to \the\valueof{/longbox/height}}%
  \setlength\lb@splitheight{\dimexpr\valueof{/longbox/height}-\valueof{/longbox/extra-single}\relax}%
  \lb@splitbox
  \ifdim\ht\lb@headbox=0pt\relax
    %split failed.. do nothing
    \lb@debug{could not restrict height}%
  \else
    % store splitted off content in the mainbox (and discard the rest)
    \setbox\lb@mainbox\vbox{\unvbox\lb@headbox}%
    \lb@debug{restricted height to \the\ht\lb@mainbox}%
  \fi
  \letvalueof{/longbox/height-align}\lb@halign
  \eifstrequal{\lb@halign}{bottom}%
    {\setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox}}}}%
  {\eifstrequal{\lb@halign}{middle}%
    {\setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox\vfill}}}}%
    {% default is top
     \advance\lb@splitheight -\ht\lb@mainbox\relax 
     \setbox\lb@mainbox=\vbox{\unvbox\lb@mainbox\kern\lb@splitheight}%
    }%
  }%
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newlength\lb@neededvspace
\newcommand\lb@typeset[1][0pt]{%
  \iftoggle{/longbox/breakable}{%
    \lb@setfreevspace
    \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\valueof{/longbox/extra-single}\relax}%
    \lb@debug{needed: \the\lb@neededvspace, available: \the\lb@freevspace}%
    \ifdim\lb@neededvspace<\lb@freevspace\relax
      \lb@single@{\lb@mainbox}%
    \else
      \lb@typeout{longbox needs splitting}%
      \setlength\lb@splitheight{\dimexpr\lb@freevspace-\valueof{/longbox/extra-first}\relax}%
      \lb@splitbox
      \ifdim\ht\lb@headbox=0pt\relax
        % failed to split
        \ifdim\dimexpr\lb@freevspace + #1\relax<\textheight\relax % test if we where at a fresh page.. (and prevent infinite recursion)
          \lb@debug{failed to split the box, inserting a page break}%
          \hrule \@height\z@ \@width\hsize
          \vfill\eject 
          \lb@typeset[\textheight]% try again, but pass \textheight to guard against infinite recursion
        \else
          % on a fresh page we should not fail anymore.. just output as is..
          % lb@warncannotsplit
          \lb@single@{\lb@mainbox}%
        \fi
      \else
        % first part success
        \lb@typeout{first part splitted}%
        \lb@first@{\lb@headbox}%
        \lb@typesetrest
      \fi
    \fi
  }{%\else
    \lb@debug{unbreakable box}%
    \lb@single@{\lb@mainbox}% always directly output an unbreakable box
  }%
}

\newcommand\lb@typesetrest{%
  \lb@setfreevspace%
  \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\valueof{/longbox/extra-last}\relax}%
  \ifdim\lb@neededvspace<\lb@freevspace\relax
    \lb@typeout{output last part of box}%
    \lb@last@{\lb@mainbox}%
  \else
    \lb@debug{split box further}%
    \setlength\lb@splitheight{\dimexpr\lb@freevspace-\valueof{/longbox/extra-middle}\relax}%
    \lb@splitbox
    \ifdim\ht\lb@headbox=0pt\relax
      % failed to split
      \lb@typeout{failed to split box!}%
      \lb@last@{\lb@mainbox}%
    \else
      % middle part success
      \lb@typeout{output middle part of box}%
      \lb@middle@{\lb@headbox}%
      \lb@typesetrest % continue the iteration...
    \fi
  \fi
}

% --------------------------------------------------------
% Split a long vbox over multiple pages.
% This code is based on similar code in the mdframed package
% --------------------------------------------------------

\newlength\lb@splitheight
\newlength\lb@insurance     % tiny extra space to ensure our box will really fit
\setlength\lb@insurance{1pt}

% expects split target height in lb@splitheight, and splits off the start of lb@mainbox to lb@headbox
\newcommand\lb@splitbox{%
  \ifdim\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax>\lb@splitheight\relax
    % the main box is larger than our target split height..
    \ifdim\valueof{/longbox/extra-split}>\lb@splitheight\relax
      % not enough space to bother
      \lb@typeout{not enough space on page for a split}%
      \setbox\lb@headbox=\vbox{}% empty head
    \else
      % try a split; lower the split height a bit so we are sure to fit
      \advance\lb@splitheight -\lb@insurance\relax
      \lb@debug{split: \the\lb@splitheight, from \the\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax}%
      \setbox\lb@savebox=\vbox{\unvcopy\lb@mainbox}% save original
      \lb@trysplit{\lb@splitheight}%
      \ifdim\dimexpr\ht\lb@headbox + \dp\lb@headbox>\lb@splitheight\relax
        % too big, bad split. Try other splits.. iterate 100 times with 1pt less before giving up
        \dimen@=\lb@splitheight\relax
        \@tempcnta=\z@\relax
        \loop
        \ifdim\dimexpr\ht\lb@headbox+\dp\lb@headbox\relax>\lb@splitheight\relax
          \advance\dimen@ by -\p@\relax% try a slightly smaller height..
          \advance\@tempcnta by \@ne\relax
          \lb@ignorevbadness
          \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore
          \lb@trysplit{\dimen@}%
          \ifdim\valueof{/longbox/extra-split}<\dimen@\relax\else\b@splitstop\fi % don't try to split too small
          \ifnum\@tempcnta<100\relax\else\lb@splitstop\fi % and not more than 100 attempts
        \repeat%
      \fi
    \fi
  \else
    % mainbox fits in our target lb@splitheight
    \setbox\lb@headbox=\vbox{\unvbox\lb@mainbox}%    
    \setbox\lb@mainbox=\vbox{}%
  \fi
}

\newcommand\lb@splitstop{%
  \lb@typeout{cannot find a good split}%
  \let\iterate\relax
  \lb@warncannotsplit
  \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore      
  \setbox\lb@headbox=\vbox{}% empty head    
}

\newcommand\lb@trysplit[1]{% try to split at given height
  \lb@typeout{try to split at: \the\dimexpr #1\relax}%
  \lb@ignorevbadness  
  \setbox\lb@headbox=\vsplit\lb@mainbox to #1\relax%
  \setbox\lb@headbox=\vbox{\unvbox\lb@headbox}%
  \setbox\lb@mainbox=\vbox{\unvbox\lb@mainbox}%  
}

% --------------------------------------------------------
% The longbox environment uses pgfkeys to set its options
% --------------------------------------------------------

% keys and styles that can be set once globally
\pgfkeys{/longbox/.is family}%

\pgfkeys{longbox,%
  debug/.is toggle=false,
  debug/.link={/longbox/verbose},
  verbose/.is toggle=false, 
  part-isfirst/.is toggle=false,
  part-ismiddle/.is toggle=false,
  part-islast/.is toggle=false,
  part-issingle/.is toggle=false,
  part-needtop/.is toggle=false,
  part-needbottom/.is toggle=false,
  part-content/.initial=\vbox{},
  part-width/.is dimexpr=0pt,
  part-height/.is dimexpr=0pt,
  part-depth/.is dimexpr=0pt,
  extra/.style={extra-single=#1, extra-first=#1, extra-middle=#1, extra-last=#1, extra-sides=#1},
  render/.style={render-single=#1, render-first=#1, render-middle=#1, render-last=#1},
  bgcolor/.forward to={/longbox/background-color},    
  height-align/.is oneof={top,middle,bottom},
  valign/.is oneof={bottom,middle,top},
  descenders/.is dimexpr=0pt,
}

\newcommand\longboxdefaultkeys{%
  \pgfkeys{longbox,%
    extra-single/.is dimexpr=-1sp,
    extra-first/.is dimexpr=0pt,
    extra-middle/.is dimexpr=0pt,
    extra-last/.is dimexpr=0pt,
    extra-split/.is dimexpr={1.5\baselineskip},
    extra-sides/.is dimexpr=0pt,
    render-single/.initial=\lb@renderdefault,
    render-first/.initial=\lb@renderdefault,
    render-middle/.initial=\lb@renderdefault,
    render-last/.initial=\lb@renderdefault,
    width/.is dimexpr={-1sp},
    width-outer/.is dimexpr=\linewidth,
    height/.is dimexpr={-1sp},
    height-outer/.is dimexpr={-1sp},
    height-align=top,
    background-color/.is color={},
    color/.is color={.},
    breakable/.is toggle=true,
    insert-before/.initial={},
    insert-after/.initial={},
  }%
}

\newcommand\longboxadjustkeys{%
  % calculate width-height from outer width-height, and extra-single as extra-first+extra-last
  \ifdim\valueof{/longbox/width}=-1sp\relax
    \ifdim\valueof{/longbox/width-outer}=-1sp\relax\else
      \lb@debug{set width}%
      \pgfkeys{/longbox/width=\valueof{/longbox/width-outer}-\valueof{/longbox/extra-sides}}%
  \fi\fi
  \ifdim\valueof{/longbox/height}=-1sp\relax
    \ifdim\valueof{/longbox/height-outer}>-1sp\relax
      \pgfkeys{/longbox/height=\valueof{/longbox/height-outer}-\valueof{/longbox/extra-single}}%
    \fi
  \fi
  \ifdim\valueof{/longbox/extra-single}=-1sp\relax
    \pgfkeys{/longbox/extra-single=\valueof{/longbox/extra-first}+\valueof{/longbox/extra-last}}%
  \fi
}

\newenvironment{longbox}[1][]{%
  % keys that are always defaulted at the start
  \longboxdefaultkeys
  \pgfkeys{longbox,#1}%
  \begin{@longbox}%
}{\end{@longbox}}

\newenvironment{@longbox}{%  
  \longboxadjustkeys
  \begin{lb@longbox}%
}{\end{lb@longbox}}

\newcommand\lbox[1][]{%
  \longboxdefaultkeys%
  \pgfkeys{longbox,#1}%
  \@lbox
}

% ------------------------------------------------------------------------------
% Define standard border styles
%
% a style has the form \md@border<style>{<side>}{<direction>}{<borderwidth>}
% where <side> is the border side
%       <direction> is either "h" or "v" (horizontal or vertical)
%       <borderwidth> the width of the rule
%
% predefined styles: none, solid, transparent, dashed, and dotted.

\newcommand*\bordernone[2]{}
\newcommand*\bordersolid[2]{\ifx#1h\relax \hrule\@height #2\else\vrule\@width #2\fi}
\newcommand*\bordertransparent[2]{\ifx#1h\relax \rule{0pt}{#2}\else\rule{#2}{0pt}\fi}

\newlength\md@dashlen
\setlength\md@dashlen{2.5pt}
\newcommand*\md@borderdashed@[1]{%
  %\md@dashlen=\dimexpr\dimmax{\md@bordertopwidth}{\dimmax{\md@borderbottomwidth}{\dimmax{\md@borderrightwidth}{\dimmax{\md@borderleftwidth}{2.5pt}}}}\relax
  \ifx#1h%
    \hbox to \valueof{/fbox/borderbox-width}{%
      \xleaders \hbox{\md@hdash\hskip 0.5\md@dashlen\relax}\hfill\hbox{\md@hdash}%
    }%
  \else 
    %\lower\valueof{/fbox/inner-depth}%
    \vbox to \valueof{/fbox/inner-height}{\offinterlineskip%
      \cleaders \vbox{\vskip0.25\md@dashlen\md@vdash\vskip0.25\md@dashlen}\vfill
    }%
  \fi
}

\newcommand*\borderdashed[2]{%
  \def\md@hdash{\vrule width \md@dashlen height #2 depth 0pt}%
  \def\md@vdash{\hrule width #2 height \md@dashlen depth 0pt}%
  \md@borderdashed@{#1}%
}
\newcommand*\borderdotted[2]{%
  \def\md@hdash{\vrule width #2 height #2 depth 0pt\relax}%
  \def\md@vdash{\hrule width #2 height #2 depth 0pt\relax}%
  \md@borderdashed@{#1}%
} 

% --------------------------------------------------------
%
% --------------------------------------------------------
\newcommand\fbox@setdim{%
  \pgfkeys{%
    /fbox/inner-height=\valueof{/longbox/part-height}%
      +\iftoggle{/longbox/part-needtop}{\valueof{/fbox/padding-top}}{\valueof{/fbox/padding-break-top}}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/padding-bottom}}{\valueof{/fbox/padding-break-bottom}},%
    /fbox/inner-depth=\valueof{/longbox/part-depth}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/padding-bottom}}{\valueof{/fbox/padding-break-bottom}},%
    /fbox/inner-width=\valueof{/longbox/part-width}%
      +\valueof{/fbox/padding-left}+\valueof{/fbox/padding-right},
    /fbox/borderbox-width=\valueof{/fbox/inner-width}%
      +\valueof{/fbox/border-left-width}+\valueof{/fbox/border-right-width},%
    /fbox/borderbox-height=\valueof{/fbox/inner-height}%
      +\iftoggle{/longbox/part-needtop}{\valueof{/fbox/border-top-width}}{\valueof{/fbox/border-break-top-width}}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/border-bottom-width}}{\valueof{/fbox/border-break-bottom-width}},%
    /fbox/borderbox-depth=\valueof{/fbox/inner-depth}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/border-bottom-width}}{\valueof{/fbox/border-break-bottom-width}},%
  }%
  \ifvalueofequal{/fbox/valign}{bbottom}%
    {\pgfkeys{/fbox/lower=-\valueof{/fbox/raise}}}%
  {\ifvalueofequal{/fbox/valign}{btop}%
    {\pgfkeys{/fbox/lower=\valueof{/fbox/borderbox-height}-\valueof{/fbox/raise}}}
    {\pgfkeys{/fbox/lower=\valueof{/fbox/borderbox-depth}-\valueof{/fbox/raise}}}}%
}

\newrobustcmd*\fbox@border[2]{%
  \begingroup
  \colorof{/fbox/border-#1-color}% set color already
  \edef\@rendername{border\valueof{/fbox/border-#1-style}}%  
  \ifcsdef{\@rendername}%
    {\csuse{\@rendername}{#2}{\valueof{/fbox/border-#1-width}}}%
    {\bordersolid{#2}{\valueof{/fbox/border-#1-width}}}%
  \endgroup
}

\newrobustcmd*\fbox@kern[3][]{%
  \iftoggle{/fbox/show-markers}{%
    \ifx#2v\relax
      \def\fbox@marker{\vrule width \valueof{/fbox/marker-width} height \valueof{#3}}%
      \eifblank{#1}{\hbox{\fbox@marker}}{\vbox{\hbox to \valueof{#1}{\fbox@marker\hfill\hfill\fbox@marker}}}%
    \else
      \def\fbox@marker{\vrule height \valueof{/fbox/marker-width} width \valueof{#3}}%
      \eifblank{#1}{\fbox@marker}{\raise \dimexpr\valueof{#1}-\valueof{/fbox/marker-width}\relax\hbox{\fbox@marker}}%
    \fi
  }%
  {\kern\valueof{#2}}%
}

\newrobustcmd*\fbox@render{%
  \begingroup
  \fbox@setdim
  \hbox{%
  \fbox@kern[/fbox/margin-bottom]{h}{/fbox/margin-left}%
    \lower \valueof{/fbox/lower}\relax
    \vbox{\offinterlineskip
    \ontoggle{/longbox/part-needtop}{\fbox@kern{v}{/fbox/margin-top}}%    
    \hbox{%
      \vcolorbox{\valueof{/longbox/background-color}}{%
        \offinterlineskip
        \ontoggle{/longbox/part-needtop}{\fbox@border{top}{h}}%
        \hbox{%
          \fbox@border{left}{v}%
          %\raise\dimexpr\valueof{/fbox/borderbox-depth}-0.4pt\relax\vbox{\hrule height 0.4pt width \valueof{/fbox/padding-left}}%
          \fbox@kern[/fbox/inner-depth]{h}{/fbox/padding-left}%
          \vbox{\offinterlineskip
            \fbox@kern[/longbox/part-width]{v}{\iftoggle{/longbox/part-needtop}{/fbox/padding-top}{/fbox/padding-break-top}}%
            \valueof{/longbox/part-content}%
            \fbox@kern[/longbox/part-width]{v}{\iftoggle{/longbox/part-needbottom}{/fbox/padding-bottom}{/fbox/padding-break-bottom}}%
          }%
          \fbox@kern[/fbox/inner-depth]{h}{/fbox/padding-right}%
          \fbox@border{right}{v}%
        }%
        \ontoggle{/longbox/part-needbottom}{\fbox@border{bottom}{h}}%
      }%
    }%
    \ontoggle{/longbox/part-needtop}{\fbox@kern{v}{/fbox/margin-bottom}}%
  }%
  \fbox@kern[/fbox/margin-bottom]{h}{/fbox/margin-right}%
  }%
  \endgroup
}

\pgfkeys{%
  /fbox/.is family,
  /fbox/.search also={/longbox},
}
\pgfkeys{fbox,
  sep/.forward to={/fbox/padding},
  rule/.forward to={/fbox/border-width},
  valign/.is oneof={bottom,middle,top,btop,bbottom},
  padding/.style={/fbox/padding-top=#1,/fbox/padding-right=#1,/fbox/padding-bottom=#1,/fbox/padding-left=#1},
  margin/.style={/fbox/margin-top=#1,/fbox/margin-right=#1,/fbox/margin-bottom=#1,/fbox/margin-left=#1},
  border-width/.style={/fbox/border-top-width=#1,/fbox/border-right-width=#1,%
                        /fbox/border-bottom-width=#1,/fbox/border-left-width=#1,%
                        /fbox/border-break-top-width=#1,/fbox/border-break-bottom-width=#1},
  border-color/.style={/fbox/border-top-color=#1,/fbox/border-right-color=#1,%
                       /fbox/border-bottom-color=#1,/fbox/border-left-color=#1,%
                       /fbox/border-break-top-color=#1,/fbox/border-break-bottom-color=#1},
  border-style/.style={/fbox/border-top-style=#1,/fbox/border-right-style=#1,%
                       /fbox/border-bottom-style=#1,/fbox/border-left-style=#1},
  border-break-style/.style={/fbox/border-break-top-style=#1,/fbox/border-break-bottom-style=#1},
  padding-break/.style={/fbox/padding-break-top=#1,/fbox/padding-break-bottom=#1},
  inner-height/.is dimexpr=0pt,
  inner-depth/.is dimexpr=0pt,
  inner-width/.is dimexpr=0pt,
  borderbox-width/.is dimexpr=0pt,
  borderbox-height/.is dimexpr=0pt,
  borderbox-depth/.is dimexpr=0pt,
  lower/.is dimexpr=0pt,
}
\newcommand\fboxdefaultkeys{%
  \longboxdefaultkeys
  \pgfkeys{fbox,
    padding-top/.is dimexpr=\fboxsep,
    padding-right/.is dimexpr=\fboxsep,
    padding-bottom/.is dimexpr=\fboxsep,
    padding-left/.is dimexpr=\fboxsep,
    padding-break-top/.is dimexpr=0.5em,
    padding-break-bottom/.is dimexpr=0.5em,
    margin-top/.is dimexpr=0pt,
    margin-right/.is dimexpr=0pt,
    margin-bottom/.is dimexpr=0pt,
    margin-left/.is dimexpr=0pt,
    border-top-width/.is dimexpr=\fboxrule,
    border-right-width/.is dimexpr=\fboxrule,
    border-bottom-width/.is dimexpr=\fboxrule,
    border-left-width/.is dimexpr=\fboxrule,
    border-break-top-width/.is dimexpr=\fboxrule,
    border-break-bottom-width/.is dimexpr=\fboxrule,    
    border-top-color/.is color={.},
    border-right-color/.is color={.},
    border-bottom-color/.is color={.},
    border-break-top-color/.is color={.},
    border-break-bottom-color/.is color={.},
    border-left-color/.is color={.},
    border-top-style/.initial=solid,
    border-right-style/.initial=solid,
    border-bottom-style/.initial=solid,
    border-left-style/.initial=solid,    
    border-break-top-style/.initial=none,
    border-break-bottom-style/.initial=none,
    raise/.is dimexpr=0pt,
    show-markers/.is toggle=true,
    marker-width/.is dimexpr=0.4pt,
    render=\fbox@render
  }%
}
\newcommand\fboxadjustkeys{%
  % set width of borders with style none to 0
  \foreach\side in {top,left,right,bottom,break-bottom,break-top} {%
    \ifvalueofequal{/fbox/border-\side-style}{none}{%
      \pgfkeys{/fbox/border-\side-width=0pt}%
    }{}%
  }%
  \ifvalueofequal{/fbox/valign}{bbottom}{}%
    {\ifvalueofequal{/fbox/valign}{btop}{}%
      {\pgfkeys{/longbox/valign/.expanded=\valueof{/fbox/valign}}}}%
  % calculate the extra space needed on each part for longbox
  \pgfkeys{%
    /longbox/extra-middle=\valueof{/fbox/padding-break-top} + \valueof{/fbox/border-break-top-width}%
                          + \valueof{/fbox/padding-break-bottom} + \valueof{/fbox/border-break-bottom-width},    
    /longbox/extra-first=\valueof{/fbox/border-top-width} + \valueof{/fbox/padding-top}%
                          + \valueof{/fbox/margin-top}%
                          + \valueof{/fbox/padding-break-bottom} + \valueof{/fbox/border-break-bottom-width},    
    /longbox/extra-last=\valueof{/fbox/border-bottom-width} + \valueof{/fbox/padding-bottom}%
                        + \valueof{/fbox/margin-bottom}%
                        + \valueof{/fbox/padding-break-top} + \valueof{/fbox/border-break-top-width},        
    /longbox/extra-sides=\valueof{/fbox/border-left-width} + \valueof{/fbox/border-right-width}%
                         + \valueof{/fbox/padding-left} + \valueof{/fbox/padding-right}%
                         + \valueof{/fbox/margin-left} + \valueof{/fbox/margin-right},
  }%
}

\newenvironment{longfbox}[1][]{%
  \fboxdefaultkeys
  \pgfkeys{fbox,#1}%
  \fboxadjustkeys
  \begin{@longbox}%
}{\end{@longbox}}

\newcommand\lfbox[2][]{%
  \fboxdefaultkeys
  \pgfkeys{fbox,#1}%
  \fboxadjustkeys
  \@lbox{#2}%
}

\makeatother

% --------------------------------------------------------
%
% --------------------------------------------------------

\parskip=0ex %\parindent=0pt
\begin{document}
\makeatletter
head=\headof{a,b,c}%
\makeatother

Test\lfbox[height=4cm]{qtest}x\begin{longfbox}[debug]qtest\end{longfbox}x

x\begin{longfbox}[background-color=gainsboro,width=4cm,height=3cm,valign=top]%
testing \color{blue}testing testing testing

And another paragraph.
\end{longfbox}%

x\lfbox[background-color=gainsboro,width=4cm,height=3cm,valign=top,raise=1ex]{%
testing \color{blue}testing testing testing

And another paragraph.
}%


Test\fbox{qtest}x


\begin{longfbox}[background-color=floralwhite,border-style=dotted,valign=top]%


Start

test x\begin{longfbox}[background-color=gainsboro,width=4cm,height=3cm,valign=top,raise=1ex]%
testing \color{blue}testing testing testing

And another paragraph.
\end{longfbox}%
x testing here.


test x\begin{minipage}[t][4cm][t]{3cm}%
testing testing testing testing

And another paragraph.
\end{minipage}%
x testing here.


\begin{longfbox}[bgcolor=gainsboro,height=4.8cm,height-align=middle,
    border-top-color=red,border-left-color=green,
    padding=1em,padding-left=2em,
    border-width=5pt,border-style=dashed,
    margin=1em]
\centering
\lipsum[1-2]
\end{longfbox}

\lipsum[2]

\lipsum[3-4]

{\color{blue}
test\footnote{test}

\begin{equation}
e = mc^2
\end{equation}

\lipsum[5-16]}

other.
\end{longfbox}

next, mdframed:

\end{document}
\begin{mdframed}[linewidth=0.4pt]

\lipsum[1-4]

{\color{blue}
test\footnote{test}

\lipsum[5-16]}

other.
\end{mdframed}

The end.

\end{document}
