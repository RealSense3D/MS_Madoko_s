\documentclass{book}
% generated by Madoko, version 0.9.5-beta
%mdk-data-line={1}

%\usepackage{madoko2}
\usepackage{xcolor}
\usepackage{pgfkeys}
\usepackage{tablefootnote}
\usepackage{mdframed}
\usepackage{lipsum}

\parskip=0ex %\parindent=0pt

% Define basic CSS colors
\providecolor{red}{HTML}{FF0000}
\providecolor{lime}{HTML}{00FF00}
\providecolor{blue}{HTML}{0000FF}

\providecolor{yellow}{HTML}{FFFF00}
\providecolor{cyan}{HTML}{00FFFF}
\providecolor{magenta}{HTML}{FF00FF}

\providecolor{navy}{HTML}{000080}
\providecolor{maroon}{HTML}{800000}
\providecolor{green}{HTML}{008000}

\providecolor{teal}{HTML}{008080}
\providecolor{purple}{HTML}{800080}
\providecolor{olive}{HTML}{808000}

\providecolor{black}{HTML}{000000}
\providecolor{dimgray}{HTML}{696969}
\providecolor{gray}{HTML}{808080}
\providecolor{darkgray}{HTML}{A9A9A9}
\providecolor{silver}{HTML}{C0C0C0}
\providecolor{lightgray}{HTML}{D3D3D3}
\providecolor{gainsboro}{HTML}{DCDCDC}
\providecolor{floralwhite}{HTML}{FFFAF0}
\providecolor{ivory}{HTML}{FFFFF0}
\providecolor{white}{HTML}{FFFFFF}
\providecolor{transparent}{named}{white}

\makeatletter


% --------------------------------------------------------
% Extensions to etoolbox
% --------------------------------------------------------

% expand an argument and test for string equality
%
% \eifstrequal{<unexpanded s>}{<string>}{<equalcode>}{<unequalcode>}
\providecommand\eifstrequal[1]{%
  \expandafter\ifstrequal\expandafter{#1}%
}

\providecommand\eifblank{%
  \expandafter\ifblank\expandafter%
}

\providecommand\ontoggle[2]{%
  \iftoggle{#1}{#2}{}%
}
\providecommand\ontogglefalse[2]{%
  \iftoggle{#1}{}{#2}%
}

% --------------------------------------------------------
% Extensions to pgfkeys
% --------------------------------------------------------
\pgfkeys{/handlers/.is toggle/.code=%
  \providetoggle{\pgfkeyscurrentpath}%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@toggle{##1}{\pgfkeyscurrentpath},%
    \pgfkeyscurrentpath/.default=true,%
    \pgfkeyscurrentpath=#1,%
  }%
  %\notblank{#1}{\pgf@handle@toggle{#1}}%
}
\def\pgf@handle@toggle#1#2{%
  %\typeout{toggle: #2=#1}%
  \ifcsdef{toggle#1}%
    {\csuse{toggle#1}{#2}\pgfkeyssetvalue{#2}{#1}}%
    {\pgfkeysvalueof{/errors-boolean expected/.@cmd}\pgfkeyscurrentkey{#1}\pgfeov}%
}

\pgfkeys{/handlers/.is color/.code=\pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@color{##1}{\pgfkeyscurrentpath},%
    \pgfkeyscurrentpath=#1,
  }%
}
\def\pgf@handle@color#1#2{%
  \typeout{color: #2=#1}%
  \pgfkeyssetvalue{#2}{#1}%
  \eifblank{#1}%
    {\colorlet{#2}{.}}%
    {\colorlet{#2}{#1}}%
}



\newcommand\letvalueof{\pgfkeysgetvalue}%
\newcommand\valueof{\pgfkeysvalueof}%
\newcommand\dimexprof[1]{\dimexpr\valueof{#1}\relax}%
\newcommand\colorof[1]{%
  \letvalueof{#1}\reserved@a
  \edef\reserved@a{\reserved@a}%
  \eifblank{\reserved@a}{}{\color{#1}}%
}

% --------------------------------------------------------
% Utilities for LaTeX internals
% --------------------------------------------------------

% Suppress the indentation on the following paragraph
\providecommand\nofirstindent{\@afterindentfalse\@afterheading}

% Suppress the paragraph skip on the following paragraph
\providecommand\nofirstparskip{\addvskip{-\parskip}}

% In contrast to addvspace, addvskip is not suppressed in a minipage
\providecommand\addvskip[1]{%
  \ifvmode
    \ifdim\lastskip=\z@
      \vskip #1\relax
    \else
      \@tempskipb#1\relax\@xaddvskip
    \fi
  \else\@noitemerr\fi
}


% unvbox a box, and return a vbox with a given background color
% \unvcolorbox{<colorspec>}{<vboxname>}
\newcommand\unvcolorbox[2]{%
  \eifblank{#1}{\vbox{\unvbox#2}}{%
    \vbox{\offinterlineskip
      \hbox to \z@{\vbox to \z@{\noindent\color{#1}\vrule\@width\wd#2\@height\ht#2\@depth\dp#2\vss}\hss}%
      \unvbox#2%  
    }%
  }%
}

% create a vbox with a given background color 
\newcommand\vcolorbox[2]{%
  \eifblank{#1}{\vbox{#2}}{%
    \setbox\z@=\vbox{#2}\relax
    \unvcolorbox{#1}{\z@}%
  }%
}%


% --------------------------------------------------------
% Capturing footnotes
% --------------------------------------------------------

% To catch the footnotes in a box and output them afterwards
% we rely on the tablefootnote package. 
% \lb@savefootnotes saves footnotes in the environment
% \lb@restorefoontes is called after the environment to inject them into the normal footnotes
\newif\iflb@savefootnotes
\providecommand\lb@savefootnotes{%
  \iflb@savefootnotes\else
    \let\footnote\tablefootnote
  \fi
   \lb@savefootnotestrue
}
\providecommand\lb@restorefootnotes{%   
  \iflb@savefootnotes\else
    \tfn@tablefootnoteprintout
    \gdef\tfn@fnt{0}%
  \fi
} 

% --------------------------------------------------------
% The following macros come from mdframed
% --------------------------------------------------------

% Determine the amount of free space left on the current page
\newlength\lb@freevspace
\newrobustcmd*\lb@setfreevspace{%
  \bgroup\@nobreakfalse\addpenalty\z@\egroup%
  \penalty\@M\relax\vskip 2\baselineskip\relax%
  \penalty9999\relax\vskip -2\baselineskip\relax%
  \penalty9999%
  \ifdim\pagegoal=\maxdimen\relax%
    \lb@freevspace=\vsize%
  \else
    \lb@freevspace=\dimexpr\pagegoal-\pagetotal-\parskip\relax%
  \fi
  \lb@debug{free space: \the\lb@freevspace, in page: \the\textheight, vsize=\the\vsize}%
}

% Insert negative vspace of the length of the current descender
\newrobustcmd*\lb@ignorelastdescenders{%
  \par\strut\par%
  \unskip\unskip\setbox0=\lastbox
  \vspace*{\dimexpr\ht\strutbox-\baselineskip\relax}%
}

% Suppress overfull-underfull vbox messages
\newrobustcmd*\lb@ignorevbadness{%
   \edef\lb@currentvbadness{\the\vbadness}%
   \vbadness=\@M%
   \afterassignment\lb@restorevbadness
}
\newrobustcmd*\lb@restorevbadness{%
  \vbadness=\lb@currentvbadness\relax
}


% --------------------------------------------------------
% The 'long vbox' (lvbox) environment collects long material 
% into a long \vbox, instead of a \hbox like a lrbox in latex.
% The collected box can contain any box, minipage, lrbox, fbox etc,
% but not outer-par material like a figure. Footnotes can be
% dealt with useing lb@savefootnotes.
%
% The material is typeset in a \vbox according to a given width.
% inside the environment, the boolean 'inlvbox' is true.
%
% \begin{tdbox}{<boxname>}{<width>}
% --------------------------------------------------------

\newif\ifinlvbox
\newcommand\lvbox[2]{%
 \setbox#1\vbox\bgroup
   \color@setgroup
     \inlvboxtrue
     \hsize#2\relax
     \columnwidth\hsize
     \textwidth\hsize
     \linewidth\hsize
     \@totalleftmargin\z@ \leftmargin\z@ \rightmargin\z@
     \leftskip\z@skip \rightskip\z@skip \@rightskip\z@skip
     \nofirstindent
     \nofirstparskip
}
\def\endlvbox{\color@endgroup\egroup}


% --------------------------------------------------------
% Debugging
% --------------------------------------------------------

\newrobustcmd\lb@debug[1]{%
  %\lb@typeout{debug: #1}%
}
\newrobustcmd\lb@typeout[1]{%
  \ontoggle{/longbox/verbose}{\typeout{longbox: #1}}%
}
\newrobustcmd\lb@warncannotsplit{%
  \PackageWarning{longbox}{Cannot split box; it seems you are using a non-splittable contents.}%
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newsavebox\lb@headbox
\newsavebox\lb@savebox
\newsavebox\lb@mainbox

% --------------------------------------------------------
%
% --------------------------------------------------------

\newrobustcmd*\lb@defbox[1]{%
  \letvalueof{/longbox/background-color}\bgcolor
  \pgfkeys{%
    /longbox/part-width/.expanded=\the\wd#1,%
    /longbox/part-height/.expanded=\the\dimexpr\dp#1 + \ht#1\relax,%
    /longbox/part-depth/.expanded=\the\dp#1,%
    /longbox/part-content=\unvcolorbox{\bgcolor}{#1},%  
  }%
}


\newrobustcmd*\lb@renderdefault{%
  \valueof{/longbox/part-content}%
}

\newrobustcmd*\lb@single@[1]{%
  \begingroup
    \toggletrue{/longbox/part-issingle}%
    \toggletrue{/longbox/part-needtop}%
    \toggletrue{/longbox/part-needbottom}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-single}%
  \endgroup
}
\newrobustcmd*\lb@first@[1]{%
  \begingroup
    \toggletrue{/longbox/part-isfirst}%
    \toggletrue{/longbox/part-needtop}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-first}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@middle@[1]{%
  \begingroup
    \toggletrue{/longbox/part-ismiddle}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-middle}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@last@[1]{%
  \begingroup
    \toggletrue{/longbox/part-islast}%
    \toggletrue{/longbox/part-needbottom}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-last}%
  \endgroup
}

% --------------------------------------------------------
%
% --------------------------------------------------------
\newenvironment{lb@longbox}{%
  \color@setgroup
  \lb@savefootnotes
  %\colorof{/longbox/color}%
  \lvbox{\lb@mainbox}{\dimexprof{/longbox/width}}%
  \valueof{/longbox/insert-before}%
}{%
  %\lb@ignorelastdescenders%
  \valueof{/longbox/insert-after}%
  \par\unskip\ifvmode\nointerlineskip\hrule \@height\z@ \@width\hsize\fi%
  \endlvbox%
  %\ifhmode\par\fi
  \ifdim\dimexprof{/longbox/height}<0pt\relax\else
    \lb@restrictheight
  \fi
  \ifinlvbox
    \iftoggle{/longbox/breakable}{%
      \lb@debug{disable breakable due to nesting of long-boxes}%
      \togglefalse{/longbox/breakable}%
    }{}%
  \fi
  \lb@typeset
  \lb@restorefootnotes
  \color@endgroup
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newcommand\lb@restrictheight{%
  \lb@typeout{restrict height to \the\dimexprof{/longbox/height}}%
  \setlength\lb@splitheight{\dimexpr\dimexprof{/longbox/height} - \dimexprof{/longbox/extra-single}\relax}%
  \lb@splitbox
  \ifdim\ht\lb@headbox=0pt\relax
    %split failed.. do nothing
    \lb@debug{could not restrict height}%
  \else
    % store splitted off content in the mainbox (and discard the rest)
    \setbox\lb@mainbox\vbox{\unvbox\lb@headbox}%
    \lb@debug{restricted height to \the\ht\lb@mainbox}%
  \fi
  \if\valueof{/longbox/height/@align}b\relax      
    \setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox}}}%
  \else\if\valueof{/longbox/height/@align}c\relax      
    \setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox\vfill}}}%
  \else % default is top
    \setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\unvbox\lb@mainbox\vfill}}}%
  \fi\fi
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newlength\lb@neededvspace
\newcommand\lb@typeset[1][0pt]{%
  \iftoggle{/longbox/breakable}{%
    \lb@setfreevspace
    \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\dimexprof{/longbox/extra-single}\relax}%
    \lb@debug{needed: \the\lb@neededvspace, available: \the\lb@freevspace}%
    \ifdim\lb@neededvspace<\lb@freevspace\relax
      \lb@single@{\lb@mainbox}%
    \else
      \lb@typeout{longbox needs splitting}%
      \setlength\lb@splitheight{\dimexpr\lb@freevspace-\dimexprof{/longbox/extra-first}\relax}%
      \lb@splitbox
      \ifdim\ht\lb@headbox=0pt\relax
        % failed to split
        \ifdim\dimexpr\lb@freevspace + #1\relax<\textheight\relax % test if we where at a fresh page.. (and prevent infinite recursion)
          \lb@debug{failed to split the box, inserting a page break}%
          \hrule \@height\z@ \@width\hsize
          \vfill\eject 
          \lb@typeset[\textheight]% try again, but pass \textheight to guard against infinite recursion
        \else
          % on a fresh page we should not fail anymore.. just output as is..
          % lb@warncannotsplit
          \lb@single@{\lb@mainbox}%
        \fi
      \else
        % first part success
        \lb@typeout{first part splitted}%
        \lb@first@{\lb@headbox}%
        \lb@typesetrest
      \fi
    \fi
  }{%\else
    \lb@debug{unbreakable box}%
    \lb@single@{\lb@mainbox}% always directly output an unbreakable box
  }%
}

\newcommand\lb@typesetrest{%
  \lb@setfreevspace%
  \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\dimexprof{/longbox/extra-last}\relax}%
  \ifdim\lb@neededvspace<\lb@freevspace\relax
    \lb@typeout{output last part of box}%
    \lb@last@{\lb@mainbox}%
  \else
    \lb@debug{split box further}%
    \setlength\lb@splitheight{\dimexpr\lb@freevspace-\dimexprof{/longbox/extra-middle}\relax}%
    \lb@splitbox
    \ifdim\ht\lb@headbox=0pt\relax
      % failed to split
      \lb@typeout{failed to split box!}%
      \lb@last@{\lb@mainbox}%
    \else
      % middle part success
      \lb@typeout{output middle part of box}%
      \lb@middle@{\lb@headbox}%
      \lb@typesetrest % continue the iteration...
    \fi
  \fi
}

% --------------------------------------------------------
% Split a long vbox over multiple pages.
% This code is based on similar code in the mdframed package
% --------------------------------------------------------

\newlength\lb@splitheight
\newlength\lb@insurance     % tiny extra space to ensure our box will really fit
\setlength\lb@insurance{1pt}

% expects split target height in lb@splitheight, and splits off the start of lb@mainbox to lb@headbox
\newcommand\lb@splitbox{%
  \ifdim\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax>\lb@splitheight\relax
    % the main box is larger than our target split height..
    \ifdim\dimexprof{/longbox/extra-split}>\lb@splitheight\relax
      % not enough space to bother
      \lb@typeout{not enough space on page for a split}%
      \setbox\lb@headbox=\vbox{}% empty head
    \else
      % try a split; lower the split height a bit so we are sure to fit
      \advance\lb@splitheight -\lb@insurance\relax
      \lb@debug{split: \the\lb@splitheight, from \the\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax}%
      \setbox\lb@savebox=\vbox{\unvcopy\lb@mainbox}% save original
      \lb@trysplit{\lb@splitheight}%
      \ifdim\dimexpr\ht\lb@headbox + \dp\lb@headbox>\lb@splitheight\relax
        % too big, bad split. Try other splits.. iterate 100 times with 1pt less before giving up
        \dimen@=\lb@splitheight\relax
        \@tempcnta=\z@\relax
        \loop
        \ifdim\dimexpr\ht\lb@headbox+\dp\lb@headbox\relax>\lb@splitheight\relax
          \advance\dimen@ by -\p@\relax% try a slightly smaller height..
          \advance\@tempcnta by \@ne\relax
          \lb@ignorevbadness
          \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore
          \lb@trysplit{\dimen@}%
          \ifdim\dimexprof{/longbox/extra-split}<\dimen@\relax\else\b@splitstop\fi % don't try to split too small
          \ifnum\@tempcnta<100\relax\else\lb@splitstop\fi % and not more than 100 attempts
        \repeat%
      \fi
    \fi
  \else
    % mainbox fits in our target lb@splitheight
    \lb@headbox=\vbox{\unvbox\lb@mainbox}%
    \lb@mainbox=\vbox{}%
  \fi
}

\newcommand\lb@splitstop{%
  \lb@typeout{cannot find a good split}%
  \let\iterate\relax
  \lb@warncannotsplit
  \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore      
  \setbox\lb@headbox=\vbox{}% empty head    
}

\newcommand\lb@trysplit[1]{% try to split at given height
  \lb@typeout{try to split at: \the\dimexpr #1\relax}%
  \lb@ignorevbadness  
  \setbox\lb@headbox=\vsplit\lb@mainbox to #1\relax%
  \setbox\lb@headbox=\vbox{\unvbox\lb@headbox}%
  \setbox\lb@mainbox=\vbox{\unvbox\lb@mainbox}%  
}

% --------------------------------------------------------
% The longbox environment uses pgfkeys to set its options
% --------------------------------------------------------

% keys and styles that can be set once globally
\pgfkeys{/longbox/.is family}%

\pgfkeys{longbox,%
  part-isfirst/.is toggle=false,
  part-ismiddle/.is toggle=false,
  part-islast/.is toggle=false,
  part-issingle/.is toggle=false,
  part-needtop/.is toggle=false,
  part-needbottom/.is toggle=false,
  part-content/.initial=\vbox{},
  part-width/.initial=0pt,
  part-height/.initial=0pt,
  part-depth/.initial=0pt,
  extra/.style={extra-single=#1, extra-first=#1, extra-middle=#1, extra-last=#1, extra-sides=#1},
  render/.style={render-single=#1, render-first=#1, render-middle=#1, render-last=#1},
  bgcolor/.forward to={/longbox/background-color},      
}

\newcommand\longboxdefaults{%
  \pgfkeys{longbox,%
    extra-single/.initial=-1sp,
    extra-first/.initial=0pt,
    extra-middle/.initial=0pt,
    extra-last/.initial=0pt,
    extra-split/.initial={1.5\baselineskip},
    extra-sides/.initial=0pt,
    render-single/.initial=\lb@renderdefault,
    render-first/.initial=\lb@renderdefault,
    render-middle/.initial=\lb@renderdefault,
    render-last/.initial=\lb@renderdefault,
    width/.initial={-1sp},
    width-outer/.initial=\linewidth,
    height/.initial={-1sp},
    height-outer/.initial={-1sp},
    height-align/.is choice,
    height-align/top/.style={height/@align=t},
    height-align/middle/.style={height/@align=c},
    height-align/center/.style={height/@align=c},
    height-align/bottom/.style={height/@align=b},
    height/@align/.initial=t,
    background-color/.is color={.},
    color/.is color={.},
    breakable/.is toggle=true,
    verbose/.is toggle=false,
    insert-before/.initial={},
    insert-after/.initial={},
  }%
}

\newenvironment{longbox}[1][]{%
  % keys that are always defaulted at the start
  \longboxdefaults
  \pgfkeys{longbox,#1}%
  \begin{@longbox}%
}{\end{@longbox}}

\newenvironment{@longbox}{%  
  % calculate width-height from outer width-height, and extra-single as extra-first+extra-last
  \ifdim\dimexprof{/longbox/width}=-1sp\relax
    \lb@debug{set width}%
    \pgfkeys{/longbox/width=\the\dimexprof{/longbox/width-outer}-\the\dimexprof{/longbox/extra-sides}}%
  \fi
  \ifdim\dimexprof{/longbox/height}=-1sp\relax
    \ifdim\dimexprof{/longbox/height-outer}>-1sp\relax
      \pgfkeys{/longbox/height=\the\dimexprof{/longbox/height-outer}-\the\dimexprof{/longbox/extra-single}}%
    \fi
  \fi
  \ifdim\dimexprof{/longbox/extra-single}=-1sp\relax
    \pgfkeys{/longbox/extra-single=\the\dimexprof{/longbox/extra-first}+\the\dimexprof{/longbox/extra-last}}%
  \fi
  \begin{lb@longbox}%
}{\end{lb@longbox}}


% ------------------------------------------------------------------------------
% Define standard border styles
%
% a style has the form \md@border<style>{<side>}{<direction>}{<borderwidth>}
% where <side> is the border side
%       <direction> is either "h" or "v" (horizontal or vertical)
%       <borderwidth> the width of the rule
%
% predefined styles: none, solid, transparent, dashed, and dotted.

\newcommand*\bordernone[2]{}
\newcommand*\bordersolid[2]{\ifx#1h\relax \hrule\@height #2\else\vrule\@width #2\fi}
\newcommand*\bordertransparent[2]{\ifx#1h\relax \rule{0pt}{#2}\else\rule{#2}{0pt}\fi}

\newlength\md@dashlen
\setlength\md@dashlen{2.5pt}
\newcommand*\md@borderdashed@[1]{%
  %\md@dashlen=\dimexpr\dimmax{\md@bordertopwidth}{\dimmax{\md@borderbottomwidth}{\dimmax{\md@borderrightwidth}{\dimmax{\md@borderleftwidth}{2.5pt}}}}\relax
  \ifx#1h%
    \hbox to \dimexprof{/fbox/border-box-width}{\xleaders \hbox{\md@hdash\hskip 0.5\md@dashlen\relax}\hfill\hbox{\md@hdash}}%
  \else 
    \lower\dimexprof{/fbox/inner-depth}\vbox to \dimexprof{/fbox/inner-height}{\cleaders \vbox{\vskip0.25\md@dashlen\md@vdash\vskip0.25\md@dashlen}\vfill}%
  \fi
}

\newcommand*\borderdashed[2]{%
  \def\md@hdash{\vrule width \md@dashlen height #2 depth 0pt}%
  \def\md@vdash{\hrule width #2 height \md@dashlen depth 0pt}%
  \md@borderdashed@{#1}%
}
\newcommand*\borderdotted[2]{%
  \def\md@hdash{\vrule width #2 height #2 depth 0pt\relax}%
  \def\md@vdash{\hrule width #2 height #2 depth 0pt\relax}%
  \md@borderdashed@{#1}%
} 

% --------------------------------------------------------
%
% --------------------------------------------------------

\newrobustcmd*\fboxborder[2]{%
  \begingroup
  \colorof{/fbox/border-#1-color}% 
  \edef\@rendername{border\valueof{/fbox/border-#1-style}}%  
  \ifcsdef{\@rendername}%
    {\csuse{\@rendername}{#2}{\dimexprof{/fbox/border-#1-width}}}%
    {\bordersolid{#2}{\dimexprof{/fbox/border-#1-width}}}%
  \endgroup
}

\newrobustcmd*\fboxsingle{%
  \begingroup
  \pgfkeys{%
    /fbox/inner-width/.initial=\the\dimexprof{/longbox/width}+\the\dimexprof{/fbox/padding-left} + \the\dimexprof{/fbox/padding-right},
    /fbox/inner-height/.initial=\the\dimexprof{/longbox/part-height} %
                                   + \ontoggle{/longbox/part-needtop}{\the\dimexprof{/fbox/padding-top}} %
                                   + \ontoggle{/longbox/part-needbottom}{\the\dimexprof{/fbox/padding-bottom}},
    /fbox/inner-depth/.initial=\the\dimexprof{/longbox/part-depth},                                  
    /fbox/border-box-width/.initial=\the\dimexprof{/fbox/inner-width} + \the\dimexprof{/fbox/border-left-width} %
                                                                      + \the\dimexprof{/fbox/border-right-width},    
  }%
  \vbox{\offinterlineskip
    \ontoggle{/longbox/part-needtop}{\vskip\dimexprof{/fbox/margin-top}}%    
    \hbox{%
      \hskip\dimexprof{/fbox/margin-left}%
      \vcolorbox{/longbox/background-color}{%
        \offinterlineskip
        \ontoggle{/longbox/part-needtop}{\fboxborder{top}{h}}%
        \hbox{%
          \fboxborder{left}{v}%
          \hskip\dimexprof{/fbox/padding-left}%
          \vbox{\offinterlineskip
            \ontoggle{/longbox/part-needtop}{\vskip\dimexprof{/fbox/padding-top}}%
            \valueof{/longbox/part-content}%
            \ontoggle{/longbox/part-needbottom}{\vskip\dimexprof{/fbox/padding-bottom}}%
          }%
          \hskip\dimexprof{/fbox/padding-right}      
          \fboxborder{right}{v}%
        }%
        \ontoggle{/longbox/part-needbottom}{\fboxborder{bottom}{h}}%
      }%
      \hskip\dimexprof{/fbox/margin-right}%
    }%
    \ontoggle{/longbox/part-needtop}{\vskip\dimexprof{/fbox/margin-top}}%
  }%
  \endgroup
}

\pgfkeys{%
  /fbox/.is family,
  /fbox/.search also={/longbox},
}
\pgfkeys{fbox,
  sep/.forward to={/fbox/padding},
  rule/.forward to={/fbox/border-width},
  padding/.style={/fbox/padding-top=#1,/fbox/padding-right=#1,/fbox/padding-bottom=#1,/fbox/padding-left=#1},
  margin/.style={/fbox/margin-top=#1,/fbox/margin-right=#1,/fbox/margin-bottom=#1,/fbox/margin-left=#1},
  border-width/.style={/fbox/border-top-width=#1,/fbox/border-right-width=#1,/fbox/border-bottom-width=#1,/fbox/border-left-width=#1},
  border-color/.style={/fbox/border-top-color=#1,/fbox/border-right-color=#1,/fbox/border-bottom-color=#1,/fbox/border-left-color=#1},
  border-style/.style={/fbox/border-top-style=#1,/fbox/border-right-style=#1,/fbox/border-bottom-style=#1,/fbox/border-left-style=#1},
}
\newcommand\fboxdefaults{%
  \longboxdefaults
  \pgfkeys{fbox,
    padding-top/.initial=\fboxsep,
    padding-right/.initial=\fboxsep,
    padding-bottom/.initial=\fboxsep,
    padding-left/.initial=\fboxsep,
    margin-top/.initial=0pt,
    margin-right/.initial=0pt,
    margin-bottom/.initial=0pt,
    margin-left/.initial=0pt,
    border-top-width/.initial=\fboxrule,
    border-right-width/.initial=\fboxrule,
    border-bottom-width/.initial=\fboxrule,
    border-left-width/.initial=\fboxrule,
    border-top-color/.is color={.},
    border-right-color/.is color={.},
    border-bottom-color/.is color={.},
    border-left-color/.is color={.},
    border-top-style/.initial=solid,
    border-right-style/.initial=solid,
    border-bottom-style/.initial=solid,
    border-left-style/.initial=solid,    
    render=\fboxsingle
  }%
}

\newenvironment{longfbox}[1][]{%
  \fboxdefaults
  \pgfkeys{fbox,#1}%
  \pgfkeys{%
    /longbox/extra-first=\the\dimexprof{/fbox/border-top-width} + \the\dimexprof{/fbox/padding-top} + \the\dimexprof{/fbox/margin-top},    
    /longbox/extra-middle=0pt,
    /longbox/extra-last=\the\dimexprof{/fbox/border-bottom-width} + \the\dimexprof{/fbox/padding-bottom} + \the\dimexprof{/fbox/margin-bottom},    
    /longbox/extra-sides=\the\dimexprof{/fbox/border-left-width} + \the\dimexprof{/fbox/padding-left} + \the\dimexprof{/fbox/margin-left} +%
                         \the\dimexprof{/fbox/border-right-width} + \the\dimexprof{/fbox/padding-right} + \the\dimexprof{/fbox/margin-right},
  }%
  \begin{@longbox}%
}{\end{@longbox}}


\makeatother

% --------------------------------------------------------
%
% --------------------------------------------------------

\parskip=0ex %\parindent=0pt
\begin{document}

Next

\newlength\fboxextra
\setlength\fboxextra{\dimexpr\fboxsep+\fboxrule\relax}
\begin{longfbox}[background-color=floralwhite,border-style=solid]

test test test test
\hbox{\begin{longfbox}[background-color=gainsboro,height=4.8cm,height-align=top,width=8cm,border-style=dotted]
\lipsum[1-2]
\end{longfbox}}x testing here.

\begin{longfbox}[bgcolor=gainsboro,height=4.8cm,height-align=top,
    border-top-color=red,border-left-color=green,
    padding=1em,padding-left=2em,
    border-width=5pt,border-style=dashed,
    margin=1em]
\centering
\lipsum[1-2]
\end{longfbox}

\lipsum[2]

\lipsum[3-4]

{\color{blue}
test\footnote{test}

\begin{equation}
e = mc^2
\end{equation}

\lipsum[5-16]}

other.
\end{longfbox}

next, mdframed:

\begin{mdframed}[linewidth=0.4pt]

\lipsum[1-4]

{\color{blue}
test\footnote{test}

\lipsum[5-16]}

other.
\end{mdframed}

The end.

\end{document}
