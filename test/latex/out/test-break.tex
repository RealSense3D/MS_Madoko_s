\documentclass{book}
% generated by Madoko, version 0.9.5-beta
%mdk-data-line={1}

%\usepackage{madoko2}
\usepackage{xcolor}
\usepackage{pgfkeys}
\usepackage{tablefootnote}
\usepackage{mdframed}
\usepackage{lipsum}

\parskip=0ex %\parindent=0pt

% Define basic CSS colors
\providecolor{red}{HTML}{FF0000}
\providecolor{lime}{HTML}{00FF00}
\providecolor{blue}{HTML}{0000FF}

\providecolor{yellow}{HTML}{FFFF00}
\providecolor{cyan}{HTML}{00FFFF}
\providecolor{magenta}{HTML}{FF00FF}

\providecolor{navy}{HTML}{000080}
\providecolor{maroon}{HTML}{800000}
\providecolor{green}{HTML}{008000}

\providecolor{teal}{HTML}{008080}
\providecolor{purple}{HTML}{800080}
\providecolor{olive}{HTML}{808000}

\providecolor{black}{HTML}{000000}
\providecolor{dimgray}{HTML}{696969}
\providecolor{gray}{HTML}{808080}
\providecolor{darkgray}{HTML}{A9A9A9}
\providecolor{silver}{HTML}{C0C0C0}
\providecolor{lightgray}{HTML}{D3D3D3}
\providecolor{gainsboro}{HTML}{DCDCDC}
\providecolor{floralwhite}{HTML}{FFFAF0}
\providecolor{ivory}{HTML}{FFFFF0}
\providecolor{white}{HTML}{FFFFFF}

\makeatletter


% --------------------------------------------------------
% Utilities
% --------------------------------------------------------

% expand an argument and test for string equality
%
% \eifstrequal{<unexpanded s>}{<string>}{<equalcode>}{<unequalcode>}
\newcommand\eifstrequal[1]{%
  \expandafter\ifstrequal\expandafter{#1}%
}

\newcommand\eifblank[1]{%
  \expandafter\ifblank\expandafter{#1}%
}

% Suppress the indentation on the following paragraph
\providecommand\nofirstindent{\@afterindentfalse\@afterheading}

% Suppress the paragraph skip on the following paragraph
\providecommand\nofirstparskip{\addvskip{-\parskip}}

% In contrast to addvspace, addvskip is not suppressed in a minipage
\providecommand\addvskip[1]{%
  \ifvmode
    \ifdim\lastskip=\z@
      \vskip #1\relax
    \else
      \@tempskipb#1\relax\@xaddvskip
    \fi
  \else\@noitemerr\fi
}


% unvbox a box, and return a vbox with a given background color
% \unvcolorbox{<colorspec>}{<vboxname>}
\newcommand\unvcolorbox[2]{%
  \eifblank{#1}{\vbox{\unvbox#2}}{%
    \vbox{\offinterlineskip
      \hbox to \z@{\vbox to \z@{\noindent\color{#1}\vrule\@width\wd#2\@height\ht#2\@depth\dp#2\vss}\hss}%
      \unvbox#2%  
    }%
  }%
}

% create a vbox with a given background color 
\newcommand\vcolorbox[2]{%
  \eifblank{#1}{\vbox{#2}}{%
    \setbox\z@=\vbox{#2}\relax
    \unvcolorbox{#1}{\z@}%
  }%
}%


% To catch the footnotes in a box and output them afterwards
% we rely on the tablefootnote package. 
% \lb@savefootnotes saves footnotes in the environment
% \lb@restorefoontes is called after the environment to inject them into the normal footnotes
\newif\iflb@savefootnotes
\providecommand\lb@savefootnotes{%
  \iflb@savefootnotes\else
    \let\footnote\tablefootnote
  \fi
   \lb@savefootnotestrue
}
\providecommand\lb@restorefootnotes{%   
  \iflb@savefootnotes\else
    \tfn@tablefootnoteprintout
    \gdef\tfn@fnt{0}%
  \fi
} 

% ---------------------------------------------------------
% The following four macros come from the mdframed package 

% Determine the amount of free space left on the current page
\newlength\lb@freevspace
\newrobustcmd*\lb@setfreevspace{%
  \bgroup\@nobreakfalse\addpenalty\z@\egroup%
  \penalty\@M\relax\vskip 2\baselineskip\relax%
  \penalty9999\relax\vskip -2\baselineskip\relax%
  \penalty9999%
  \ifdim\pagegoal=\maxdimen\relax%
    \lb@freevspace=\vsize%
  \else
    \lb@freevspace=\dimexpr\pagegoal-\pagetotal-\parskip\relax%
  \fi
  \lb@debug{free space: \the\lb@freevspace, in page: \the\textheight, vsize=\the\vsize}%
}

% Insert negative vspace of the length of the current descender
\newrobustcmd*\lb@ignorelastdescenders{%
  \par\strut\par%
  \unskip\unskip\setbox0=\lastbox
  \vspace*{\dimexpr\ht\strutbox-\baselineskip\relax}%
}

% Suppress overfull/underfull vbox messages
\newrobustcmd*\lb@ignorevbadness{%
   \edef\lb@currentvbadness{\the\vbadness}%
   \vbadness=\@M%
   \afterassignment\lb@restorevbadness
}
\newrobustcmd*\lb@restorevbadness{%
  \vbadness=\lb@currentvbadness\relax
}


% --------------------------------------------------------
% The 'long vbox' (lvbox) environment collects long material 
% into a long \vbox, instead of a \hbox like a lrbox in latex.
% The collected box can contain any box, minipage, lrbox, fbox etc,
% but not outer-par material like a figure. Footnotes can be
% dealt with useing lb@savefootnotes.
%
% The material is typeset in a \vbox according to a given width.
% inside the environment, the boolean 'inlvbox' is true.
%
% \begin{tdbox}{<boxname>}{<width>}
% --------------------------------------------------------

\newif\ifinlvbox
\newcommand\lvbox[2]{%
 \setbox#1\vbox\bgroup
   \color@setgroup
     \inlvboxtrue
     \hsize#2\relax
     \columnwidth\hsize
     \textwidth\hsize
     \linewidth\hsize
     \@totalleftmargin\z@ \leftmargin\z@ \rightmargin\z@
     \leftskip\z@skip \rightskip\z@skip \@rightskip\z@skip
     \nofirstindent
     \nofirstparskip
}
\def\endlvbox{\color@endgroup\egroup}


% --------------------------------------------------------
% Debugging
% --------------------------------------------------------

\newif\iflb@verbose
\newrobustcmd\lb@debug[1]{%
  \lb@typeout{debug: #1}%
}
\newrobustcmd\lb@typeout[1]{%
  \iflb@verbose\typeout{longbox: #1}\fi
}
\newrobustcmd\lb@warncannotsplit{%
  \PackageWarning{longbox}{Cannot split box; it seems you are using a non-splittable contents.}%
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newif\iflb@breakable
\newif\iflbfirst
\newif\iflbmiddle
\newif\iflblast
\newif\iflbsingle
\newif\iflbneedtop    % single or first
\newif\iflbneedbottom % single or last

\newsavebox\lb@headbox
\newsavebox\lb@savebox
\newsavebox\lb@mainbox

% --------------------------------------------------------
%
% --------------------------------------------------------

\newrobustcmd*\lb@defbox[1]{%
  \lboptiondef{background/color}\bgcolor
  \def\BOXCONTENT{\unvcolorbox{\bgcolor}{#1}}%  
  \def\width{\wd#1}%
  \def\height{\ht#1}%
  \def\depth{\dp#1}%
  \let\totalheight\@ovri
  \totalheight\height
  \advance\totalheight\depth  
}


\newrobustcmd*\lb@renderdefault{%
  \BOXCONTENT
}

\newrobustcmd*\lb@single@[1]{%
  \begingroup\lbsingletrue\lbneedtoptrue\lbneedbottomtrue
    \lb@defbox{#1}%
    \lboption{render/single}%
  \endgroup
}
\newrobustcmd*\lb@first@[1]{%
  \begingroup\lbfirsttrue\lbneedtoptrue
    \lb@defbox{#1}%
    \lboption{render/first}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@middle@[1]{%
  \begingroup\lbmiddletrue
    \lb@defbox{#1}%
    \lboption{render/middle}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@last@[1]{%
  \begingroup\lblasttrue\lbneedbottomtrue
    \lb@defbox{#1}%
    \lboption{render/last}%
  \endgroup
}

% --------------------------------------------------------
%
% --------------------------------------------------------
\pgfkeys{/handlers/.is bool/.code=\pgfkeysalso{%
    \pgfkeyscurrentpath/.code=\lb@handlebool{#1}{##1},
    \pgfkeyscurrentpath/.initial=\expandafter\@firstoftwo,%    
    \pgfkeyscurrentpath/.default=true%
  }%
}
\def\lb@handlebool#1#2{%
  \eifstrequal{#2}{true}%
    {\pgfkeyssetvalue{\pgfkeyscurrentpath}{\expandafter\@firstoftwo}}%
    {\eifstrequal{#2}{false}%
      {\pgfkeyssetvalue{\pgfkeyscurrentpath}{\expandafter\@secondoftwo}}%
      {\pgfkeysvalueof{/errors/boolean expected/.@cmd}\pgfkeyscurrentkey{#2}\pgfeov}%
    }%
}


\newcommand\lboptiondef[1]{\pgfkeysgetvalue{/longbox/#1}}
\newcommand\lboption[1]{\pgfkeysvalueof{/longbox/#1}}
\newcommand\lblength[1]{\dimexpr\lboption{#1}\relax}
\let\lbcolor\lboption
\let\lboptionif\lboption

\newenvironment{lb@longbox}{%
  \color@setgroup
  \lb@savefootnotes
  \colorlet{currentcolor}{.}%
  \lvbox{\lb@mainbox}{\lblength{width}}%
  \lboption{insert/before}%
}{%
  %\lb@ignorelastdescenders%
  \lboption{insert/after}%
  \par\unskip\ifvmode\nointerlineskip\hrule \@height\z@ \@width\hsize\fi%
  \endlvbox%
  %\ifhmode\par\fi
  \ifdim\lblength{height}<0pt\relax\else
    \lb@restrictheight
  \fi
  \iflb@breakable\ifinlvbox
    \lb@debug{disable breakable due to nesting of long-boxes}%
    \lb@breakablefalse
  \fi\fi
  \lb@typeset
  \lb@restorefootnotes
  \color@endgroup
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newcommand\lb@restrictheight{%
  \lb@typeout{restrict height to \the\lblength{height}}%
  \setlength\lb@splitheight{\dimexpr\lblength{height} - \lblength{extra/single}\relax}%
  \lb@splitbox
  \ifdim\ht\lb@headbox=0pt\relax
    %split failed.. do nothing
    \lb@debug{could not restrict height}%
  \else
    % store splitted off content in the mainbox (and discard the rest)
    \setbox\lb@mainbox\vbox{\unvbox\lb@headbox}%
    \lb@debug{restricted height to \the\ht\lb@mainbox}%
  \fi
  \if\lboption{height/@align}b\relax      
    \setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox}}}%
  \else\if\lboption{height/@align}c\relax      
    \setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox\vfill}}}%
  \else % default is top
    \setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\unvbox\lb@mainbox\vfill}}}%
  \fi\fi
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newlength\lb@neededvspace
\newcommand\lb@typeset[1][0pt]{%
  \iflb@breakable
    \lb@setfreevspace
    \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\lblength{extra/single}\relax}%
    \lb@debug{needed: \the\lb@neededvspace, available: \the\lb@freevspace}%
    \ifdim\lb@neededvspace<\lb@freevspace\relax
      \lb@single@{\lb@mainbox}%
    \else
      \lb@typeout{longbox needs splitting}%
      \setlength\lb@splitheight{\dimexpr\lb@freevspace-\lblength{extra/first}\relax}%
      \lb@splitbox
      \ifdim\ht\lb@headbox=0pt\relax
        % failed to split
        \ifdim\dimexpr\lb@freevspace + #1\relax<\textheight\relax % test if we where at a fresh page.. (and prevent infinite recursion)
          \lb@debug{failed to split the box, inserting a page break}%
          \hrule \@height\z@ \@width\hsize
          \vfill\eject 
          \lb@typeset[\textheight]% try again, but pass \textheight to guard against infinite recursion
        \else
          % on a fresh page we should not fail anymore.. just output as is..
          % lb@warncannotsplit
          \lb@single@{\lb@mainbox}%
        \fi
      \else
        % first part success
        \lb@typeout{first part splitted}%
        \lb@first@{\lb@headbox}%
        \lb@typesetrest
      \fi
    \fi
  \else
    \lb@debug{unbreakable box}%
    \lb@single@{\lb@mainbox}% always directly output an unbreakable box
  \fi
}

\newcommand\lb@typesetrest{%
  \lb@setfreevspace%
  \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\lblength{extra/last}\relax}%
  \ifdim\lb@neededvspace<\lb@freevspace\relax
    \lb@typeout{output last part of box}%
    \lb@last@{\lb@mainbox}%
  \else
    \lb@debug{split box further}%
    \setlength\lb@splitheight{\dimexpr\lb@freevspace-\lblength{extra/middle}\relax}%
    \lb@splitbox
    \ifdim\ht\lb@headbox=0pt\relax
      % failed to split
      \lb@typeout{failed to split box!}%
      \lb@last@{\lb@mainbox}%
    \else
      % middle part success
      \lb@typeout{output middle part of box}%
      \lb@middle@{\lb@headbox}%
      \lb@typesetrest % continue the iteration...
    \fi
  \fi
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newlength\lb@splitheight
\newlength\lb@insurance     % tiny extra space to ensure our box will really fit
\setlength\lb@insurance{1pt}

% expects split target height in lb@splitheight, and splits off the start of lb@mainbox to lb@headbox
\newcommand\lb@splitbox{%
  \ifdim\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax>\lb@splitheight\relax
    % the main box is larger than our target split height..
    \ifdim\lblength{extra/split}>\lb@splitheight\relax
      % not enough space to bother
      \lb@typeout{not enough space on page for a split}%
      \setbox\lb@headbox=\vbox{}% empty head
    \else
      % try a split; lower the split height a bit so we are sure to fit
      \advance\lb@splitheight -\lb@insurance\relax
      \lb@debug{split: \the\lb@splitheight, from \the\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax}%
      \setbox\lb@savebox=\vbox{\unvcopy\lb@mainbox}% save original
      \lb@trysplit{\lb@splitheight}%
      \ifdim\dimexpr\ht\lb@headbox + \dp\lb@headbox>\lb@splitheight\relax
        % too big, bad split. Try other splits.. iterate 100 times with 1pt less before giving up
        \dimen@=\lb@splitheight\relax
        \@tempcnta=\z@\relax
        \loop
        \ifdim\dimexpr\ht\lb@headbox+\dp\lb@headbox\relax>\lb@splitheight\relax
          \advance\dimen@ by -\p@\relax% try a slightly smaller height..
          \advance\@tempcnta by \@ne\relax
          \lb@ignorevbadness
          \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore
          \lb@trysplit{\dimen@}%
          \ifdim\lblength{extra/split}<\dimen@\relax\else\b@splitstop\fi % don't try to split too small
          \ifnum\@tempcnta<100\relax\else\lb@splitstop\fi % and not more than 100 attempts
        \repeat%
      \fi
    \fi
  \else
    % mainbox fits in our target lb@splitheight
    \lb@headbox=\vbox{\unvbox\lb@mainbox}%
    \lb@mainbox=\vbox{}%
  \fi
}

\newcommand\lb@splitstop{%
  \lb@typeout{cannot find a good split}%
  \let\iterate\relax
  \lb@warncannotsplit
  \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore      
  \setbox\lb@headbox=\vbox{}% empty head    
}

\newcommand\lb@trysplit[1]{% try to split at given height
  \lb@typeout{try to split at: \the\dimexpr #1\relax}%
  \lb@ignorevbadness  
  \typeoutinfo{split}%    
  \setbox\lb@headbox=\vsplit\lb@mainbox to #1\relax%
  \setbox\lb@headbox=\vbox{\unvbox\lb@headbox}%
  \setbox\lb@mainbox=\vbox{\unvbox\lb@mainbox}%  
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newenvironment{longbox}[1][]{%
  \pgfqkeys{/longbox}{%
    extra/single/.initial=0pt,
    extra/first/.initial=0pt,
    extra/middle/.initial=0pt,
    extra/last/.initial=0pt,
    extra/split/.initial={1.5\baselineskip},
    extra/sides/.initial=0pt,
    extra/.style={extra/single=##1, extra/first=##1, extra/middle=##1, extra/last=##1, extra/sides=##1},
    render/single/.initial=\lb@renderdefault,
    render/first/.initial=\lb@renderdefault,
    render/middle/.initial=\lb@renderdefault,
    render/last/.initial=\lb@renderdefault,
    render/.style={render/single=##1, render/first=##1, render/middle=##1, render/last=##1},
    width/.initial={-1sp},
    width/outer/.initial=\linewidth,
    height/.initial={-1sp},
    height/outer/.initial={-1sp},
    height/align/.is choice,
    height/align/top/.style={height/@align=t},
    height/align/middle/.style={height/@align=c},
    height/align/center/.style={height/@align=c},
    height/align/bottom/.style={height/@align=b},
    height/@align/.initial=t,
    background/color/.initial={},
    bgcolor/.forward to={/longbox/background/color},
    breakable/.is if=lb@breakable,breakable=true,
    verbose/.is if=lb@verbose,verbose=true,
    insert/before/.initial={},
    insert/after/.initial={},
  }%
  \pgfqkeys{/longbox}{#1}%
  % calculate width/height from outer width/height
  \ifdim\lblength{width}=-1sp\relax
    \lb@debug{set width}%
    \pgfqkeys{/longbox}{width=\the\lblength{width/outer}-\the\lblength{extra/sides}}%
  \fi
  \ifdim\lblength{height}=-1sp\relax
    \ifdim\lblength{height/outer}>-1sp\relax
      \pgfqkeys{/longbox}{height=\the\lblength{height/outer}-\the\lblength{extra/single}}%
    \fi
  \fi
  \begin{lb@longbox}%
}{\end{lb@longbox}}

\newcommand\typeoutinfo[1]{%
  \lb@debug{msg #1: \the\linewidth, \the\@totalleftmargin, \the\leftmargin, \the\textwidth, \the\hsize.}%
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newrobustcmd*\fboxsingle{%
  \begingroup
  \fboxsep\z@
  %\noindent\colorbox{floralwhite}{%
  %\fboxsep3pt%    
  %\raise\dimexpr0.7\baselineskip+\fboxsep+\fboxrule
  \vcolorbox{floralwhite}{%
  %\vbox{%
    \fboxsep3pt%
    \offinterlineskip
    \iflbneedtop{\color{currentcolor}\hrule height \fboxrule}\fi%
    \hbox{%
      {\color{currentcolor}\vrule width \fboxrule}%
      \hskip\fboxsep
      \vbox{\offinterlineskip
        \iflbneedtop\vskip\fboxsep\fi
        \BOXCONTENT%
        \iflbneedbottom\vskip\fboxsep\fi
      }%
      \hskip\fboxsep      
      {\color{currentcolor}\vrule width \fboxrule}%
    }%
    \iflbneedbottom{\color{currentcolor}\hrule height \fboxrule}\fi%
  }%
  %\noindent\unvcolorbox{floralwhite}{\z@}%
  \endgroup
}


\makeatother

% --------------------------------------------------------
%
% --------------------------------------------------------

\parskip=0ex %\parindent=0pt
\begin{document}

Next

\pgfqkeys{/longbox}{test/.is bool=,test}
\lboptionif{test}{yes}{no}

\newlength\fboxextra
\setlength\fboxextra{\dimexpr\fboxsep+\fboxrule\relax}
\begin{longbox}[render=\fboxsingle,
  extra=2\fboxsep+2\fboxrule,
  extra/first=\fboxsep+\fboxrule,
  extra/last=\fboxsep+\fboxrule,
  extra/middle=0pt,
  background/color=floralwhite]

test test test test
\hbox{x\begin{longbox}[render=\fboxsingle,extra=2\fboxextra,bgcolor=gainsboro,height=4.8cm,height/align=top,width=6cm]
\lipsum[1-2]
\end{longbox}}and more testing here.

\begin{longbox}[render=\fboxsingle,extra=2\fboxextra,bgcolor=gainsboro,height=4.8cm,height/align=top]
\centering
\lipsum[1-2]
\end{longbox}

\lipsum[2]

\lipsum[3-4]

{\color{blue}
test\footnote{test}

\begin{equation}
e = mc^2
\end{equation}

\lipsum[5-16]}

other.
\end{longbox}

next, mdframed:

\begin{mdframed}[linewidth=0.4pt]

\lipsum[1-4]

{\color{blue}
test\footnote{test}

\lipsum[5-16]}

other.
\end{mdframed}

The end.

\end{document}
