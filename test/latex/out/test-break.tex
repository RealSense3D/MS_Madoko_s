\documentclass{book}
% generated by Madoko, version 0.9.5-beta
%mdk-data-line={1}

%\usepackage{madoko2}
\usepackage{etoolbox}
\usepackage{xcolor}
\usepackage{pgfkeys}
\usepackage{footnote}
%\usepackage{tablefootnote}
%\usepackage{mdframed}
\usepackage{lipsum}

\parskip=0ex %\parindent=0pt

% Define basic CSS colors
\providecolor{red}{HTML}{FF0000}
\providecolor{lime}{HTML}{00FF00}
\providecolor{blue}{HTML}{0000FF}

\providecolor{yellow}{HTML}{FFFF00}
\providecolor{cyan}{HTML}{00FFFF}
\providecolor{magenta}{HTML}{FF00FF}

\providecolor{navy}{HTML}{000080}
\providecolor{maroon}{HTML}{800000}
\providecolor{green}{HTML}{008000}

\providecolor{teal}{HTML}{008080}
\providecolor{purple}{HTML}{800080}
\providecolor{olive}{HTML}{808000}

\providecolor{black}{HTML}{000000}
\providecolor{dimgray}{HTML}{696969}
\providecolor{gray}{HTML}{808080}
\providecolor{darkgray}{HTML}{A9A9A9}
\providecolor{silver}{HTML}{C0C0C0}
\providecolor{lightgray}{HTML}{D3D3D3}
\providecolor{gainsboro}{HTML}{DCDCDC}
\providecolor{floralwhite}{HTML}{FFFAF0}
\providecolor{ivory}{HTML}{FFFFF0}
\providecolor{white}{HTML}{FFFFFF}
\providecolor{transparent}{named}{white}

\makeatletter


% --------------------------------------------------------
% Extensions to etoolbox
% --------------------------------------------------------

% expand an argument and test for string equality
%
% \eifstrequal{<unexpanded s>}{<string>}{<equalcode>}{<unequalcode>}
\providecommand\eifstrequal[1]{%
  \expandafter\ifstrequal\expandafter{#1}%
}

\providecommand\eifblank[1]{%
  \protected@edef\@ifblankarg{#1}%
  \expandafter\ifblank\expandafter{\@ifblankarg}%
}

\providecommand\ontoggle[2]{%
  \iftoggle{#1}{#2}{}%
}

\providecommand\providelength[1]{% 
  \ifdef{#1}{}{\newlength#1}%
}

\providecommand\csnewlength[1]{%
  \expandafter\newlength\csname #1\endcsname%
}
\providecommand\csprovidelength[1]{%
  \ifcsdef{#1}{}{\expandafter\newlength\csname #1\endcsname}%
}
\providecommand\cssetlength[2]{%
  \expandafter\setlength\csname #1\endcsname{#2}%
}

% --------------------------------------------------------
% Extensions to pgfkeys
% --------------------------------------------------------
\newcommand\pgf@gethead[2]{%
  \def\do##1{\xdef#2{##1}\listbreak}%
  \docsvlist{#1}%
}

\def\pgfkeyssetvalue@#1#2{%
  \pgfkeyssetvalue{#2}{#1}%
}

\def\pgf@setroot@/#1/#2\relax{\def\pgfroot{#1}}
\def\pgf@setroot#1{%
  \edef\reserved@a{#1}%
  \expandafter\pgf@setroot@\reserved@a//\relax\relax
}


\pgfkeys{/handlers/.set/.code=%
  \edef\pgf@savepath{\pgfkeysdefaultpath}%
  \pgfkeysalso{\pgfkeyscurrentpath/.cd,#1}%
  \let\pgfkeysdefaultpath\pgf@savepath%
}

\pgfkeys{/handlers/.init/.code=%
  \pgfkeysifdefined{\pgfkeyscurrentpath}%
    {\pgfkeysalso{\pgfkeyscurrentpath=#1}}%
    {\pgfkeyssetvalue{\pgfkeyscurrentpath}{#1}}%  
  \pgf@setroot{\pgfkeyscurrentpath}%
  %\typeout{init: \pgfkeyscurrentkey, \pgfkeyscurrentpath=#1, root=\pgfroot}%
  \pgfkeysifdefined{/\pgfroot/.@init}{}{\pgfkeyssetvalue{/\pgfroot/.@init}{}}%
  \edef\pgf@init{\pgfkeyscurrentpath={#1},}%
  \pgfkeysalso{/\pgfroot/.@init/.append/.expand once=\pgf@init}%
}

\newcommand\pgfkeysinit[1]{%
%  \typeout{init all: #1}%
%  \def\do##1{\pgf@doinit{##1}}%
%  \docsvlist{#1}%
%}
%\newcommand\pgf@doinit[1]{%
  \pgfkeysifdefined{/#1/.@init}{%
    \letvalueof{/#1/.@init}\pgf@defaultsettings
    %\typeout{initialize: #1 with \pgf@defaultsettings}%
    \expandafter\pgfkeys\expandafter{\pgf@defaultsettings}%
  }{}%
}

\pgfkeys{/handlers/.is oneof/.code=%
  \pgf@gethead{#1}\lb@head%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@oneof{##1}{\pgfkeyscurrentpath}{#1},%
    \pgfkeyscurrentpath=\lb@head,% default is the first item in the list
  }%
}
\def\pgf@handle@oneof#1#2#3{%
  \expandafter\pgf@handle@oneof@\expandafter{#1}{#2}{#3}%
}
\def\pgf@handle@oneof@#1#2#3{%
  \lb@debug{oneof: #2=#1 in #3}%
  \let\pgf@oneof\relax%
  \def\do##1{%
    \eifstrequal{##1}{#1}{%
      \xdef\pgf@oneof{##1}%
      \listbreak
    }{}%
  }%
  \docsvlist{#3}%
  \ifx\pgf@oneof\relax
    \pgfkeysvalueof{/errors/unknown choice value/.@cmd}{#2={#3}}{#1}\pgfeov%
  \else
    \pgfkeyssetvalue{#2}{#1}%
  \fi
}


\pgfkeys{/handlers/.is toggle/.code=%
  %\typeout{define toggle: \pgfkeyscurrentpath}%
  \providetoggle{\pgfkeyscurrentpath}%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@toggle{##1}{\pgfkeyscurrentpath},%
    \pgfkeyscurrentpath/.default=true,%
  }%
  \ifx\pgfkeyscurrentvalue\pgfkeysnovalue@text\else
    \pgfkeysalso{\pgfkeyscurrentpath=#1}%
  \fi%
}

\def\pgf@handle@toggle#1#2{%
  \lb@debug{toggle: #2=#1}%
  \ifcsdef{toggle#1}%
    {\csuse{toggle#1}{#2}\pgfkeyssetvalue{#2}{#1}}%
    {\pgfkeysvalueof{/errors-boolean expected/.@cmd}\pgfkeyscurrentkey{#1}\pgfeov}%
}

\pgfkeys{/handlers/.is color/.code=%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@color{##1}{\pgfkeyscurrentpath}%
  }%
  \ifx\pgfkeyscurrentvalue\pgfkeysnovalue@text\else
    \pgfkeysalso{\pgfkeyscurrentpath=#1}
  \fi%
}
\def\pgf@handle@color#1#2{%
  \lb@debug{color: #2=#1}%
  \eifstrequal{#1}{transparent}{\pgfkeyssetvalue{#2}{}}{\pgfkeyssetvalue{#2}{#1}}%
  \eifblank{#1}{\colorlet{#2}{.}}{\colorlet{#2}{#1}}%
}

\pgfkeys{/handlers/.is dimexpr/.code=%
  %\typeout{is dimexpr: \pgfkeyscurrentpath=#1}%
  \csprovidelength{length@\pgfkeyscurrentpath}%
  \expandafter\pgfkeyssetvalue@\csname length@\pgfkeyscurrentpath\endcsname{\pgfkeyscurrentpath}%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@handle@dimexpr{##1}{\pgfkeyscurrentpath},%
  }%
  \eifblank{#1}{}{\pgfkeysalso{\pgfkeyscurrentpath=#1}}
}
\def\pgf@handle@dimexpr#1#2{%
  %\typeout{dimexpr: #2=#1 == \the\dimexpr#1\relax}%  
  \cssetlength{length@#2}{\dimexpr#1\relax}%
}

\pgfkeys{/handlers/.is sides/.code=%
  \edef\pgf@empty##1##2##3##4{}%
  \edef\pgf@temp##1##2##3##4{#1}%
  \ifx\pgf@temp\pgf@empty\relax
    \edef\pgf@temp##1##2##3##4{%
      \pgfkeyscurrentpath-top=##1,\pgfkeyscurrentpath-right=##2,%
      \pgfkeyscurrentpath-bottom=##3,\pgfkeyscurrentpath-left=##4}%
  \fi
  \pgfkeyslet{\pgfkeyscurrentpath/.@sides}{\pgf@temp}%
  \pgfkeysalso{%
    \pgfkeyscurrentpath/.ecode=\noexpand\pgf@sides@handle{\pgfkeyscurrentpath}{##1}%
  }%
}

\newcommand\pgf@sides@handle[2]{%
  \pgf@sides@parse#2,,,,\relax#1\relax
}
\def\pgf@sides@parse#1,#2,#3,#4,#5\relax#6\relax{%
  \ifblank{#2#3#4}{\pgf@sides@set{#1}{#1}{#1}{#1}{#6}}%
  {\ifblank{#3#4}{\pgf@sides@set{#1}{#2}{#1}{#2}{#6}}%
  {\ifblank{#4}{\pgf@sides@set{#1}{#2}{#3}{#2}{#6}}%
               {\pgf@sides@set{#1}{#2}{#3}{#4}{#6}}%
  }}%
}
\newcommand\pgf@sides@set[5]{%
  \lb@debug{setting #5=#1,#2,#3,#4}%
  \pgfkeysgetvalue{#5/.@sides}\pgf@temp%  
  \expandafter\pgfkeysalso\expandafter{\pgf@temp{#1}{#2}{#3}{#4}}% 
}

\newcommand\letvalueof{\pgfkeysgetvalue}%
\newcommand\valueof{\pgfkeysvalueof}%
\newcommand\colorof[1]{%
  \letvalueof{#1}\reserved@a
  \eifblank{\reserved@a}{}{\color{#1}}%
}
\newcommand\ifvalueofequal[1]{%
  \letvalueof{#1}\reserved@a
  \eifstrequal{\reserved@a}%
}
\newcommand\ifvalueofblank[1]{%
  \letvalueof{#1}\reserved@a
  \eifblank{\reserved@a}%
}

% --------------------------------------------------------
% Utilities for LaTeX internals
% --------------------------------------------------------

% Suppress the indentation on the following paragraph
\providecommand\nofirstindent{\@afterindentfalse\@afterheading}

% Suppress the paragraph skip on the following paragraph
\providecommand\nofirstparskip{\addvskip{-\parskip}}

% In contrast to addvspace, addvskip is not suppressed in a minipage
\providecommand\addvskip[1]{%
  \ifvmode
    \ifdim\lastskip=\z@
      \vskip #1\relax
    \else
      \@tempskipb#1\relax\@xaddvskip
    \fi
  \else\@noitemerr\fi
}


% unvbox a box, and return a vbox with a given background color
% \unvcolorbox{<colorspec>}{<vboxname>}
\newcommand\unvcolorbox[2]{%
  \eifblank{#1}{\vbox{\unvbox#2}}{%
    \lb@debug{vcolorbox: #1}%
    \vbox{\offinterlineskip
      \hbox to \z@{\vbox to \z@{\noindent\color{#1}\vrule\@width\wd#2\@height\ht#2\@depth\dp#2\vss}\hss}%
      \unvbox#2%  
    }%
  }%
}

% create a vbox with a given background color 
\newcommand\vcolorbox[2]{%
  \eifblank{#1}{\vbox{#2}}{%
    \setbox\z@=\vbox{#2}\relax
    \unvcolorbox{#1}{\z@}%
  }%
}%


% --------------------------------------------------------
% Capturing footnotes
% --------------------------------------------------------

% To catch the footnotes in a box and output them afterwards
% we rely on the tablefootnote package. 
% \lb@savefootnotes saves footnotes in the environment
% \lb@restorefoontes is called after the environment to inject them into the normal footnotes
\newif\iflb@savefootnotes
\providecommand\lb@savefootnotes{%
  \iflb@savefootnotes\else
    \let\footnote\tablefootnote
  \fi
   \lb@savefootnotestrue
}
\providecommand\lb@restorefootnotes{%   
  \iflb@savefootnotes\else
    \tfn@tablefootnoteprintout
    \gdef\tfn@fnt{0}%
  \fi
} 

% --------------------------------------------------------
% The following macros come from mdframed
% --------------------------------------------------------

% Determine the amount of free space left on the current page
\newlength\lb@freevspace
\newrobustcmd*\lb@setfreevspace{%
  \bgroup\@nobreakfalse\addpenalty\z@\egroup%
  \penalty\@M\relax\vskip 2\baselineskip\relax%
  \penalty9999\relax\vskip -2\baselineskip\relax%
  \penalty9999%
  \ifdim\pagegoal=\maxdimen\relax%
    \lb@freevspace=\vsize%
  \else
    \lb@freevspace=\dimexpr\pagegoal-\pagetotal-\parskip\relax%
  \fi
  \lb@debug{free space: \the\lb@freevspace, in page: \the\textheight, vsize=\the\vsize}%
}

% Suppress overfull-underfull vbox messages
\newrobustcmd*\lb@ignorevbadness{%
   \edef\lb@currentvbadness{\the\vbadness}%
   \vbadness=\@M%
   \afterassignment\lb@restorevbadness
}
\newrobustcmd*\lb@restorevbadness{%
  \vbadness=\lb@currentvbadness\relax
}


% --------------------------------------------------------
% The 'long vbox' (lvbox) environment collects long material 
% into a long \vbox, instead of a \hbox like a lrbox in latex.
% The collected box can contain any box, minipage, lrbox, fbox etc,
% but not outer-par material like a figure. Footnotes can be
% dealt with useing lb@savefootnotes.
%
% The material is typeset in a \vbox according to a given width.
% inside the environment, the boolean 'inlvbox' is true.
%
% \begin{tdbox}{<boxname>}{<width>}
% --------------------------------------------------------

\newif\ifinlvbox
\newcommand\lvbox[2]{%
 \setbox#1\vbox\bgroup
   \begingroup
   \inlvboxtrue
   \hsize#2\relax
   \columnwidth\hsize
   \textwidth\hsize
   \linewidth\hsize
   \@totalleftmargin\z@ \leftmargin\z@ \rightmargin\z@
   \leftskip\z@skip \rightskip\z@skip \@rightskip\z@skip
   \nofirstindent
   %\nofirstparskip
}
\def\endlvbox{\endgroup\egroup}


% --------------------------------------------------------
% Debugging
% --------------------------------------------------------

\newrobustcmd\lb@debug[1]{%
  \ontoggle{/longbox/debug}{\typeout{longbox debug: #1}}%
}
\newrobustcmd\lb@typeout[1]{%
  \ontoggle{/longbox/verbose}{\typeout{longbox: #1}}%
}
\newrobustcmd\lb@warncannotsplit{%
  \PackageWarning{longbox}{Cannot split box; it seems you are using a non-splittable contents.}%
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newsavebox\lb@headbox
\newsavebox\lb@savebox
\newsavebox\lb@mainbox

% --------------------------------------------------------
%
% --------------------------------------------------------

\newrobustcmd*\lb@defbox[1]{%
  \ifvalueofequal{/longbox/valign}{top}%
    {\setbox#1=\vtop{\unvbox#1}}%
  {\ifvalueofequal{/longbox/valign}{middle}%
    {\setbox#1=\vbox{\hbox{\lower \dimexpr(\dp#1 + \ht#1)/2\relax\vbox{\unvbox#1}}}}%
    {}}%
    %{\setbox#1=\vbox{\hbox{\lower \dimexpr\lb@descenders\relax\vbox{\unvbox#1}}}}}%    
  \pgfkeys{%
    /longbox/part-width=\wd#1,%
    /longbox/part-height=\dp#1 + \ht#1,%
    /longbox/part-depth=\dp#1,%
    /longbox/part-content=\unvcolorbox{\valueof{/longbox/background-color}}{#1},%
  }%
}


\newrobustcmd*\lb@renderdefault{%
  \valueof{/longbox/part-content}%
}

\newrobustcmd*\lb@single@[1]{%
  \begingroup
    \toggletrue{/longbox/part-issingle}%
    \toggletrue{/longbox/part-needtop}%
    \toggletrue{/longbox/part-needbottom}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-single}%
  \endgroup
}
\newrobustcmd*\lb@first@[1]{%
  \begingroup
    \toggletrue{/longbox/part-isfirst}%
    \toggletrue{/longbox/part-needtop}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-first}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@middle@[1]{%
  \begingroup
    \toggletrue{/longbox/part-ismiddle}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-middle}%
    \vfill\eject
  \endgroup
}
\newrobustcmd*\lb@last@[1]{%
  \begingroup
    \toggletrue{/longbox/part-islast}%
    \toggletrue{/longbox/part-needbottom}%
    \lb@defbox{#1}%
    \valueof{/longbox/render-last}%
  \endgroup
}

% --------------------------------------------------------
%
% --------------------------------------------------------
\newenvironment{lb@longbox}{%
  \begingroup
  \savenotes
  \ifdim\valueof{/longbox/width}=-1sp\relax
    \pgfkeys{/longbox/width=\linewidth-\valueof{/longbox/extra-sides}}%
  \fi
  \lvbox{\lb@mainbox}{\valueof{/longbox/width}}%
  \valueof{/longbox/insert-before}% 
}{%
  \valueof{/longbox/insert-after}%
  \par\unskip
  \endlvbox%  
  \lb@debug{initial lvbox: \the\dp\lb@mainbox, \the\ht\lb@mainbox, \the\wd\lb@mainbox}%
  \lb@processbox
  \spewnotes
  \endgroup
}

\newcommand\@lbox[1]{%  
  \longboxadjustkeys
  \leavevmode
  \setbox\lb@mainbox=\hbox{%
    \color@begingroup
    \valueof{/longbox/insert-before}%
    #1%
    \valueof{/longbox/insert-before}%
    \color@endgroup
  }%
  %\lb@debug{initial lbox: \the\dp\lb@mainbox, \the\ht\lb@mainbox, \the\wd\lb@mainbox}%
  \ifdim\valueof{/longbox/width}=-1sp\relax
    \pgfkeys{/longbox/width=\wd\lb@mainbox}%
  \fi
  \setbox\lb@mainbox=\vbox{\hbox to \valueof{/longbox/width}{\unhbox\lb@mainbox}}%
  \lb@processbox
}

\newcommand\lb@processbox{%
  \ifdim\valueof{/longbox/height}<0pt\relax\else
    \lb@restrictheight
  \fi
  \ifinlvbox
    \iftoggle{/longbox/breakable}{%
      \lb@debug{disable breakable due to nesting of long-boxes}%
      \togglefalse{/longbox/breakable}%
    }{}%
  \fi
  \ifhmode\lb@single@{\lb@mainbox}\else\lb@typeset\fi  
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newcommand\lb@restrictheight{%
  \lb@typeout{restrict height to \the\valueof{/longbox/height}}%
  \setlength\lb@splitheight{\dimexpr\valueof{/longbox/height}-\valueof{/longbox/extra-single}\relax}%
  %lb@debug{before height split: \the\dp\lb@mainbox, \the\ht\lb@mainbox, \the\wd\lb@mainbox}%
  \lb@splitbox
  \ifdim\ht\lb@headbox=0pt\relax
    %split failed.. do nothing
    \lb@debug{could not restrict height}%
  \else
    % store splitted off content in the mainbox (and discard the rest)
    \setbox\lb@mainbox\vbox{\unvbox\lb@headbox}%
    \lb@debug{restricted height to \the\ht\lb@mainbox}%
  \fi
  \letvalueof{/longbox/height-align}\lb@halign
  \eifstrequal{\lb@halign}{bottom}%
    {\setbox\lb@mainbox=\vbox{\hbox{\vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox}}}}%
  {\eifstrequal{\lb@halign}{middle}%
    {\setbox\lb@mainbox=\vbox{\hbox{%
          \lower \dimexpr0.5\lb@splitheight-\dp\lb@mainbox\relax%
          \vbox to \lb@splitheight{\vfill\unvbox\lb@mainbox\vfill}}}}%
    {% default is top
     \advance\lb@splitheight -\ht\lb@mainbox\relax
     \advance\lb@splitheight -\dp\lb@mainbox\relax 
     \setbox\lb@mainbox=\vtop{\unvbox\lb@mainbox\kern\lb@splitheight}%
    }%
  }%
}

% --------------------------------------------------------
%
% --------------------------------------------------------

\newlength\lb@neededvspace
\newcommand\lb@typeset[1][0pt]{%
  \iftoggle{/longbox/breakable}{%
    \lb@setfreevspace
    \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\valueof{/longbox/extra-single}\relax}%
    \lb@debug{needed: \the\lb@neededvspace, available: \the\lb@freevspace}%
    \ifdim\lb@neededvspace<\lb@freevspace\relax
      \lb@single@{\lb@mainbox}%
    \else
      \lb@typeout{longbox needs splitting}%
      \setlength\lb@splitheight{\dimexpr\lb@freevspace-\valueof{/longbox/extra-first}\relax}%
      \lb@splitbox
      \ifdim\ht\lb@headbox=0pt\relax
        % failed to split
        \ifdim\dimexpr\lb@freevspace + #1\relax<\textheight\relax % test if we where at a fresh page.. (and prevent infinite recursion)
          \lb@debug{failed to split the box, inserting a page break}%
          \hrule \@height\z@ \@width\hsize
          \vfill\eject 
          \lb@typeset[\textheight]% try again, but pass \textheight to guard against infinite recursion
        \else
          % on a fresh page we should not fail anymore.. just output as is..
          % lb@warncannotsplit
          \lb@single@{\lb@mainbox}%
        \fi
      \else
        % first part success
        \lb@typeout{first part splitted}%
        \lb@first@{\lb@headbox}%
        \lb@typesetrest
      \fi
    \fi
  }{%\else
    \lb@debug{unbreakable box}%
    \lb@single@{\lb@mainbox}% always directly output an unbreakable box
  }%
}

\newcommand\lb@typesetrest{%
  \lb@setfreevspace%
  \setlength\lb@neededvspace{\dimexpr\ht\lb@mainbox+\dp\lb@mainbox+\valueof{/longbox/extra-last}\relax}%
  \ifdim\lb@neededvspace<\lb@freevspace\relax
    \lb@typeout{output last part of box}%
    \lb@last@{\lb@mainbox}%
  \else
    \lb@debug{split box further}%
    \setlength\lb@splitheight{\dimexpr\lb@freevspace-\valueof{/longbox/extra-middle}\relax}%
    \lb@splitbox
    \ifdim\ht\lb@headbox=0pt\relax
      % failed to split
      \lb@typeout{failed to split box!}%
      \lb@last@{\lb@mainbox}%
    \else
      % middle part success
      \lb@typeout{output middle part of box}%
      \lb@middle@{\lb@headbox}%
      \lb@typesetrest % continue the iteration...
    \fi
  \fi
}

% --------------------------------------------------------
% Split a long vbox over multiple pages.
% This code is based on similar code in the mdframed package
% --------------------------------------------------------

\newlength\lb@splitheight
\newlength\lb@insurance     % tiny extra space to ensure our box will really fit
\setlength\lb@insurance{1pt}

% expects split target height in lb@splitheight, and splits off the start of lb@mainbox to lb@headbox
\newcommand\lb@splitbox{%
  \ifdim\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax>\lb@splitheight\relax
    % the main box is larger than our target split height..
    \ifdim\valueof{/longbox/extra-split}>\lb@splitheight\relax
      % not enough space to bother
      \lb@typeout{not enough space on page for a split}%
      \setbox\lb@headbox=\vbox{}% empty head
    \else
      % try a split; lower the split height a bit so we are sure to fit
      \advance\lb@splitheight -\lb@insurance\relax
      \lb@debug{split: \the\lb@splitheight, from \the\dimexpr\ht\lb@mainbox + \dp\lb@mainbox\relax}%
      \setbox\lb@savebox=\vbox{\unvcopy\lb@mainbox}% save original
      \lb@trysplit{\lb@splitheight}%
      \ifdim\dimexpr\ht\lb@headbox + \dp\lb@headbox>\lb@splitheight\relax
        % too big, bad split. Try other splits.. iterate 100 times with 1pt less before giving up
        \dimen@=\lb@splitheight\relax
        \@tempcnta=\z@\relax
        \loop
        \ifdim\dimexpr\ht\lb@headbox+\dp\lb@headbox\relax>\lb@splitheight\relax
          \advance\dimen@ by -\p@\relax% try a slightly smaller height..
          \advance\@tempcnta by \@ne\relax
          \lb@ignorevbadness
          \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore
          \lb@trysplit{\dimen@}%
          \ifdim\valueof{/longbox/extra-split}<\dimen@\relax\else\b@splitstop\fi % don't try to split too small
          \ifnum\@tempcnta<100\relax\else\lb@splitstop\fi % and not more than 100 attempts
        \repeat%
      \fi
    \fi
  \else
    % mainbox fits in our target lb@splitheight
    \setbox\lb@headbox=\vbox{\unvbox\lb@mainbox}%    
    \setbox\lb@mainbox=\vbox{}%
  \fi
}

\newcommand\lb@splitstop{%
  \lb@typeout{cannot find a good split}%
  \let\iterate\relax
  \lb@warncannotsplit
  \setbox\lb@mainbox=\vbox{\unvcopy\lb@savebox}% restore      
  \setbox\lb@headbox=\vbox{}% empty head    
}

\newcommand\lb@trysplit[1]{% try to split at given height
  \lb@typeout{try to split at: \the\dimexpr #1\relax}%
  \lb@ignorevbadness  
  \setbox\lb@headbox=\vsplit\lb@mainbox to #1\relax%
  \setbox\lb@headbox=\vbox{\unvbox\lb@headbox}%
  \setbox\lb@mainbox=\vbox{\unvbox\lb@mainbox}%  
}

% --------------------------------------------------------
% The longbox environment uses pgfkeys to set its options
% --------------------------------------------------------

% keys and styles that can be set once globally
\pgfkeys{/longbox/.is family}%

\pgfkeys{longbox,%
  % global options
  debug/.is toggle=false,
  verbose/.is toggle=false,
  part-isfirst/.is toggle=false,
  part-ismiddle/.is toggle=false,
  part-islast/.is toggle=false,
  part-issingle/.is toggle=false,
  part-needtop/.is toggle=false,
  part-needbottom/.is toggle=false,
  part-content/.initial=\vbox{},
  part-width/.is dimexpr=0pt,
  part-height/.is dimexpr=0pt,
  part-depth/.is dimexpr=0pt,
  extra/.style={/longbox/extra-single=#1, /longbox/extra-first=#1, 
                /longbox/extra-middle=#1, /longbox/extra-last=#1, /longbox/extra-sides=#1},
  render/.style={/longbox/render-single=#1, /longbox/render-first=#1, 
                  /longbox/render-middle=#1, /longbox/render-last=#1},
  bgcolor/.forward to={/longbox/background-color},%
  % scoped (.init) options
  extra-single/.set={.is dimexpr,.init=-1sp},
  extra-first/.set={.is dimexpr,.init=0pt},
  extra-middle/.set={.is dimexpr,.init=0pt},
  extra-last/.set={.is dimexpr,.init=0pt},
  extra-split/.set={.is dimexpr,.init={1.5\baselineskip}},
  extra-sides/.set={.is dimexpr,.init=0pt},
  render-single/.init=\lb@renderdefault,
  render-first/.init=\lb@renderdefault,
  render-middle/.init=\lb@renderdefault,
  render-last/.init=\lb@renderdefault,
  width/.set={.is dimexpr,.init=-1sp},
  width-outer/.set={.is dimexpr,.init=-1sp},
  height/.set={.is dimexpr,.init=-1sp},
  height-outer/.set={.is dimexpr,.init=-1sp},
  height-align/.set={.is oneof={top,middle,bottom},.init=top},
  valign/.set={.is oneof={bottom,middle,top},.init=bottom},
  background-color/.set={.is color,.init={}},
  color/.set={.is color,.init={.}},
  breakable/.set={.is toggle,.init=true},
  insert-before/.init={},
  insert-after/.init={},
}

\newcommand\longboxadjustkeys{%
  % calculate width-height from outer width-height, and extra-single as extra-first+extra-last
  \ifdim\valueof{/longbox/width}=-1sp\relax
    \ifdim\valueof{/longbox/width-outer}=-1sp\relax\else
      \lb@debug{set width}%
      \pgfkeys{/longbox/width=\valueof{/longbox/width-outer}-\valueof{/longbox/extra-sides}}%
  \fi\fi
  \ifdim\valueof{/longbox/height}=-1sp\relax
    \ifdim\valueof{/longbox/height-outer}>-1sp\relax
      \pgfkeys{/longbox/height=\valueof{/longbox/height-outer}-\valueof{/longbox/extra-single}}%
    \fi
  \fi
  \ifdim\valueof{/longbox/extra-single}=-1sp\relax
    \pgfkeys{/longbox/extra-single=\valueof{/longbox/extra-first}+\valueof{/longbox/extra-last}}%
  \fi
}

\newenvironment{longbox}[1][]{%
  % keys that are always defaulted at the start
  \pgfkeysinit{longbox}% set initial values
  \pgfkeys{longbox,#1}%
  \begin{@longbox}%
}{\end{@longbox}}

\newenvironment{@longbox}{%  
  \longboxadjustkeys
  \begin{lb@longbox}%
}{\end{lb@longbox}}

\newcommand\lbox[1][]{%
  \pgfkeysinit{longbox}% set initial values
  \pgfkeys{longbox,width-outer=-1sp,#1}%
  \@lbox
}

% ------------------------------------------------------------------------------
% Define standard border styles
%
% a style has the form \md@border<style>{<side>}{<direction>}{<borderwidth>}
% where <side> is the border side
%       <direction> is either "h" or "v" (horizontal or vertical)
%       <borderwidth> the width of the rule
%
% predefined styles: none, solid, transparent, dashed, and dotted.

\newcommand*\bordernone[2]{}
\newcommand*\bordersolid[2]{\ifx#1h\relax \hrule\@height #2\else\vrule\@width #2\fi}
\newcommand*\bordertransparent[2]{\ifx#1h\relax \rule{0pt}{#2}\else\rule{#2}{0pt}\fi}

\newlength\md@dashlen
\setlength\md@dashlen{2.5pt}
\newcommand*\md@borderdashed@[1]{%
  %\md@dashlen=\dimexpr\dimmax{\md@bordertopwidth}{\dimmax{\md@borderbottomwidth}{\dimmax{\md@borderrightwidth}{\dimmax{\md@borderleftwidth}{2.5pt}}}}\relax
  \ifx#1h%
    \hbox to \valueof{/fbox/borderbox-width}{%
      \xleaders \hbox{\md@hdash\hskip 0.5\md@dashlen\relax}\hfill\hbox{\md@hdash}%
    }%
  \else 
    %\lower\valueof{/fbox/inner-depth}%
    \vbox to \valueof{/fbox/inner-height}{\offinterlineskip%
      \cleaders \vbox{\vskip0.25\md@dashlen\md@vdash\vskip0.25\md@dashlen}\vfill
    }%
  \fi
}

\newcommand*\borderdashed[2]{%
  \def\md@hdash{\vrule width \md@dashlen height #2 depth 0pt}%
  \def\md@vdash{\hrule width #2 height \md@dashlen depth 0pt}%
  \md@borderdashed@{#1}%
}
\newcommand*\borderdotted[2]{%
  \def\md@hdash{\vrule width #2 height #2 depth 0pt\relax}%
  \def\md@vdash{\hrule width #2 height #2 depth 0pt\relax}%
  \md@borderdashed@{#1}%
} 

% --------------------------------------------------------
%
% --------------------------------------------------------
\newcommand\fbox@setdim{%
  \pgfkeys{%
    /fbox/inner-height=\valueof{/longbox/part-height}%
      +\iftoggle{/longbox/part-needtop}{\valueof{/fbox/padding-top}}{\valueof{/fbox/padding-break-top}}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/padding-bottom}}{\valueof{/fbox/padding-break-bottom}},%
    /fbox/inner-depth=\valueof{/longbox/part-depth}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/padding-bottom}}{\valueof{/fbox/padding-break-bottom}},%
    /fbox/inner-width=\valueof{/longbox/part-width}%
      +\valueof{/fbox/padding-left}+\valueof{/fbox/padding-right},
    /fbox/borderbox-width=\valueof{/fbox/inner-width}%
      +\valueof{/fbox/border-left-width}+\valueof{/fbox/border-right-width},%
    /fbox/borderbox-height=\valueof{/fbox/inner-height}%
      +\iftoggle{/longbox/part-needtop}{\valueof{/fbox/border-top-width}}{\valueof{/fbox/border-break-top-width}}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/border-bottom-width}}{\valueof{/fbox/border-break-bottom-width}},%
    /fbox/borderbox-depth=\valueof{/fbox/inner-depth}%
      +\iftoggle{/longbox/part-needbottom}{\valueof{/fbox/border-bottom-width}}{\valueof{/fbox/border-break-bottom-width}},%
  }%
  \ifvalueofequal{/fbox/valign}{bbottom}%
    {\pgfkeys{/fbox/lower=-\valueof{/fbox/raise}}}%
  {\ifvalueofequal{/fbox/valign}{btop}%
    {\pgfkeys{/fbox/lower=\valueof{/fbox/margin-bottom}+\valueof{/fbox/borderbox-height}-\valueof{/fbox/raise}}}
    {\pgfkeys{/fbox/lower=\valueof{/fbox/margin-bottom}+\valueof{/fbox/borderbox-depth}-\valueof{/fbox/raise}}}}%
}

\newrobustcmd*\fbox@border[2]{%
  \begingroup
  \colorof{/fbox/border-#1-color}% set color already
  \edef\@rendername{border\valueof{/fbox/border-#1-style}}%  
  \ifcsdef{\@rendername}%
    {\csuse{\@rendername}{#2}{\valueof{/fbox/border-#1-width}}}%
    {\bordersolid{#2}{\valueof{/fbox/border-#1-width}}}%
  \endgroup
}

\newrobustcmd*\fbox@kern[3][]{%
  \iftoggle{/fbox/show-markers}{%
    \ifx#2v\relax
      \def\fbox@marker{\vrule width \valueof{/fbox/marker-width} height \valueof{#3}}%
      \eifblank{#1}{\hbox{\fbox@marker}}{\vbox{\hbox to \valueof{#1}{\fbox@marker\hfill\hfill\fbox@marker}}}%
    \else
      \def\fbox@marker{\vrule height \valueof{/fbox/marker-width} width \valueof{#3}}%
      \setlength\dimen@{\valueof{/fbox/marker-width}}%
      \eifblank{#1}{}{\advance\dimen@ \dimexpr -\valueof{#1}\relax\relax}%
      \lower \dimen@\hbox{\fbox@marker}%
    \fi
  }%
  {\kern\valueof{#2}}%
}

\newrobustcmd*\fbox@render{%
  \begingroup
  \fbox@setdim
  \hbox{%
  \fbox@kern{h}{/fbox/margin-left}%
    \lower \valueof{/fbox/lower}\relax
    \vbox{\offinterlineskip
    \ontoggle{/longbox/part-needtop}{\fbox@kern{v}{/fbox/margin-top}}%    
    \hbox{%
      \vcolorbox{\valueof{/fbox/padding-color}}{% .. also becomes background color if not set explicitly :-(
        \offinterlineskip
        \iftoggle{/longbox/part-needtop}{\fbox@border{top}{h}}{\fbox@border{break-top}{h}}%
        \hbox{%
          \fbox@border{left}{v}%
          \fbox@kern[/fbox/inner-depth]{h}{/fbox/padding-left}%
          \vbox{\offinterlineskip
            \fbox@kern[/longbox/part-width]{v}{\iftoggle{/longbox/part-needtop}{/fbox/padding-top}{/fbox/padding-break-top}}%
            \valueof{/longbox/part-content}%
            \fbox@kern[/longbox/part-width]{v}{\iftoggle{/longbox/part-needbottom}{/fbox/padding-bottom}{/fbox/padding-break-bottom}}%
          }%
          \fbox@kern[/fbox/inner-depth]{h}{/fbox/padding-right}%
          \fbox@border{right}{v}%
        }%
        \iftoggle{/longbox/part-needbottom}{\fbox@border{bottom}{h}}{\fbox@border{break-bottom}{h}}%
      }%
    }%
    \ontoggle{/longbox/part-needtop}{\fbox@kern{v}{/fbox/margin-bottom}}%
  }%
  \fbox@kern{h}{/fbox/margin-right}%
  }%
  \endgroup
}

\pgfkeys{%
  /fbox/.is family,
  /fbox/.search also={/longbox},
}
\pgfkeys{fbox,
  % global keys and styles
  sep/.forward to={/fbox/padding},
  rule/.forward to={/fbox/border-width},
  valign/.is oneof={bottom,middle,top,btop,bbottom},
  margin/.is sides,
  padding/.is sides,
  border-width/.is sides={/fbox/border-top-width=#1,/fbox/border-right-width=#2,%
                          /fbox/border-bottom-width=#3,/fbox/border-left-width=#4,%
                          /fbox/border-break-top-width=#1,/fbox/border-break-bottom-width=#3},
  border-color/.is sides={/fbox/border-top-color=#1,/fbox/border-right-color=#2,%
                          /fbox/border-bottom-color=#3,/fbox/border-left-color=#4,%
                          /fbox/border-break-top-color=#1,/fbox/border-break-bottom-color=#3},
  border-style/.is sides={/fbox/border-top-style=#1,/fbox/border-right-style=#2,%
                          /fbox/border-bottom-style=#3,/fbox/border-left-style=#4},
  border-break-style/.style={/fbox/border-break-top-style=#1,/fbox/border-break-bottom-style=#1},
  padding-break/.style={/fbox/padding-break-top=#1,/fbox/padding-break-bottom=#1},
  inner-height/.is dimexpr=0pt,,
  inner-depth/.is dimexpr=0pt,,
  inner-width/.is dimexpr=0pt,,
  borderbox-width/.is dimexpr=0pt,,
  borderbox-height/.is dimexpr=0pt,,
  borderbox-depth/.is dimexpr=0pt,,
  lower/.is dimexpr=0pt,,%
  % scoped (init) keys
  padding-top/.set={.is dimexpr,.init=\fboxsep},
  padding-right/.set={.is dimexpr,.init=\fboxsep},
  padding-bottom/.set={.is dimexpr,.init=\fboxsep},
  padding-left/.set={.is dimexpr,.init=\fboxsep},
  padding-break-top/.set={.is dimexpr,.init=0.5em},
  padding-break-bottom/.set={.is dimexpr,.init=0.5em},
  padding-color/.set={.is color,.init={}},
  margin-top/.set={.is dimexpr,.init=0pt},
  margin-right/.set={.is dimexpr,.init=0pt},
  margin-bottom/.set={.is dimexpr,.init=0pt},
  margin-left/.set={.is dimexpr,.init=0pt},
  border-top-width/.set={.is dimexpr,.init=\fboxrule},
  border-right-width/.set={.is dimexpr,.init=\fboxrule},
  border-bottom-width/.set={.is dimexpr,.init=\fboxrule},
  border-left-width/.set={.is dimexpr,.init=\fboxrule},
  border-break-top-width/.set={.is dimexpr,.init=\fboxrule},
  border-break-bottom-width/.set={.is dimexpr,.init=\fboxrule},    
  border-top-color/.set={.is color,.init={.}},
  border-right-color/.set={.is color,.init={.}},
  border-bottom-color/.set={.is color,.init={.}},
  border-break-top-color/.set={.is color,.init={.}},
  border-break-bottom-color/.set={.is color,.init={.}},
  border-left-color/.set={.is color,.init={.}},
  border-top-style/.init=solid,
  border-right-style/.init=solid,
  border-bottom-style/.init=solid,
  border-left-style/.init=solid,    
  border-break-top-style/.init=none,
  border-break-bottom-style/.init=none,
  raise/.set={.is dimexpr,.init=0pt},
  show-markers/.set={.is toggle,.init=true},
  marker-width/.set={.is dimexpr,.init=0.4pt},  
}

\newcommand\fboxadjustkeys{%
  % set width of borders with style none to 0
  \def\do##1{%
    \ifvalueofequal{/fbox/border-##1-style}{none}{%
      \pgfkeys{/fbox/border-##1-width=0pt}%
    }{}%
  }%
  \docsvlist{top,left,right,bottom,break-bottom,break-top}%
  \ifvalueofblank{/fbox/padding-color}%
    {\pgfkeys{/fbox/padding-color=\valueof{/longbox/background-color}}}{}%
  \ifvalueofequal{/fbox/valign}{bbottom}{}%
    {\ifvalueofequal{/fbox/valign}{btop}{}%
      {\pgfkeys{/longbox/valign/.expanded=\valueof{/fbox/valign}}}}%
  % calculate the extra space needed on each part for longbox
  \pgfkeys{%
    /longbox/extra-middle=\valueof{/fbox/padding-break-top} + \valueof{/fbox/border-break-top-width}%
                          + \valueof{/fbox/padding-break-bottom} + \valueof{/fbox/border-break-bottom-width},    
    /longbox/extra-first=\valueof{/fbox/border-top-width} + \valueof{/fbox/padding-top}%
                          + \valueof{/fbox/margin-top}%
                          + \valueof{/fbox/padding-break-bottom} + \valueof{/fbox/border-break-bottom-width},    
    /longbox/extra-last=\valueof{/fbox/border-bottom-width} + \valueof{/fbox/padding-bottom}%
                        + \valueof{/fbox/margin-bottom}%
                        + \valueof{/fbox/padding-break-top} + \valueof{/fbox/border-break-top-width},        
    /longbox/extra-sides=\valueof{/fbox/border-left-width} + \valueof{/fbox/border-right-width}%
                         + \valueof{/fbox/padding-left} + \valueof{/fbox/padding-right}%
                         + \valueof{/fbox/margin-left} + \valueof{/fbox/margin-right},
  }%
}

\newenvironment{longfbox}[1][]{%
  \pgfkeysinit{longbox}%
  \pgfkeysinit{fbox}% set to initial values
  \pgfkeys{fbox,/longbox/render=\fbox@render,#1}% add new keys
  \fboxadjustkeys
  \begin{@longbox}%
}{\end{@longbox}}

\newcommand\lfbox[2][]{%
  \begingroup
  \pgfkeysinit{longbox}%
  \pgfkeysinit{fbox}%
  \pgfkeys{fbox,/longbox/render=\fbox@render,/longbox/width-outer=-1sp,#1}%
  \fboxadjustkeys
  \@lbox{#2}%
  \endgroup
}

\makeatother

% --------------------------------------------------------
%
% --------------------------------------------------------

\parskip=0ex %\parindent=0pt

\begin{document}

Here is a longer paragraph that I am writing.
Here is a longer paragraph that I am writing.
Here is a \lfbox[margin=1em,valign=bottom]{longer paragraph} that I am writing.
Here is a longer paragraph that I am writing.
Here is a longer paragraph that I am writing.

Test\lfbox[padding-color=red,background-color=ivory]{qtest}x\begin{longfbox}[]qtest\end{longfbox}x

x\begin{longfbox}[background-color=gainsboro,width=4cm,height=3cm,valign=top]%
testing \color{blue}testing testing testing

And another paragraph.
\end{longfbox}%

x\lfbox[background-color=gainsboro,width=4cm,height=3cm,height-align=middle,valign=top,raise=1ex]{%
testing \color{blue}testing testing testing

And another paragraph.
}%


Test\fbox{qtest}x

\begin{longfbox}[background-color=floralwhite,%
  border-style=dotted,border-color=red,valign=top,%
  border-break-top-style=solid,border-break-bottom-style=dashed,
  ]%


Start

test x\begin{longfbox}[background-color=transparent,width=3cm,height=4cm,valign=top]%
testing \color{blue}testing testing testing

And another paragraph.
\end{longfbox}%
x testing here.


test x\begin{minipage}[t][4cm][t]{3cm}%
testing testing testing testing

And another paragraph.
\end{minipage}%
x testing here.


\begin{longfbox}[bgcolor=gainsboro,height=4.8cm,height-align=middle,
    border-color={red,,,green},
    padding={1em,1em,1em,2em},
    border-width={1pt,2pt,3pt,4pt},border-style={dashed,solid,dotted},
    margin=1em]
\centering
\lipsum[1-2]
\end{longfbox}

\lipsum[2]

\lipsum[3-4]

{\color{blue}
test\footnote{test}

\begin{equation}
e = mc^2
\end{equation}

\lipsum[5-16]}

other.
\end{longfbox}

next, mdframed:

\end{document}
\begin{mdframed}[linewidth=0.4pt]

\lipsum[1-4]

{\color{blue}
test\footnote{test}

\lipsum[5-16]}

other.
\end{mdframed}

The end.

\end{document}
