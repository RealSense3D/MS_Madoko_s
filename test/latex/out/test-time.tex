\documentclass{book}

\usepackage{etoolbox}
\usepackage{xkeyval}
\usepackage{pgfkeys}
\usepackage{options}

\begin{document}
\makeatletter



\options{%
  /bench/.new family,
  /bench/style/.new choice    = {simple,complex,show},
  /bench/library/.new choice  = {baseline,options,pgfkeys,xkeyval},
  /bench/repetitions/.new num = 10000,
  /bench/baseline/.new num    = 730,
  /bench/trace/.new toggle,
}

\options{/bench, library=xkeyval, style=show, repetitions=100000}


\newcommand\preparetest[1]{
	\eifstrequal{#1}{options}{%
		\options{%
			/bar/bar-test/.new value = hi,
      /foo/foo-test/.new value = world,
			/foo/.new family={/bar},
		}    
		\def\test##1{\options{/foo,##1}}
		\def\valueof##1##2{\option{/##1/##2}}
	}
	{\eifstrequal{#1}{pgfkeys}{%
		\pgfkeys{%
			/bar/bar-test/.initial=hi,
      /foo/foo-test/.initial=world,
			/foo/.is family,
			/foo/.search also={/bar},
		}
		\def\test##1{\pgfkeys{/foo,##1}}
		\def\valueof##1##2{\pgfkeysvalueof{/##1/##2}}
	}
	{\eifstrequal{#1}{xkeyval}{%
		\define@cmdkey{bar}{bar-test}{}%
    \define@cmdkey{foo}{foo-test}{}%
		\define@cmdkey{foo}{x}{}%
		\def\test##1{\setkeys{foo,bar}{##1}}%
		\def\valueof##1##2{\csuse{cmdKV@##1@##2}}%
	}
	{\@latex@error{Cannot test package "#1"}}%
	}}%
}



\newcount\testcount
\newcommand\testtencomplex{%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%
  \test{bar-test={a test}}%  
  \advance\testcount -10\relax
}

\newcommand\testtensimple{%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \test{foo-test={a test}}%
  \advance\testcount -10\relax
}

\newcommand\runtest[2][\option{/bench/repetitions}]{%
	\preparetest{#2}%
  \iftoggle{/bench/trace}
   {{\tracingmacros 1\relax\test{bar-test={a test}}}}
   {\typeout{test \option{/bench/style} "#2": (#1\space repetitions)}
  	\expandafter\let\expandafter\testproc\csname testten\option{/bench/style}\endcsname 
    \testcount=#1\relax%	    
    \@whilenum\testcount>0\do\testproc
  	\typeout{test "#2": " \valueof{bar}{bar-test}, \valueof{foo}{foo-test}"}%
   }
}


\newcommand\adjust[2][1]{%
  %\the\numexpr#2 - \baseline\relax ms (
  \the\numexpr (#2 - \baseline)/#1\relax ms/1000%
  %)
}
\newcommand\relative[1]{%
  \dotit{\the\numexpr(10 * #1)/\baserelative\relax}x \ifnum\baserelative=#1\relax\else slower\fi
}
\newcommand\dotit[1]{\expandafter\dotitx#1\relax}
\def\dotitx#1#2#3\relax{\ifblank{#3}{#1.#2}{#1#2.#3}}

\newcommand\gentable[7][100]{%
  \def\baseline{#2}%
  \def\baserelative{#3}%
  \noindent\begin{tabular}{lrrl}\hline
  \multicolumn{3}{l}{\textbf{test}: #6} \\ 
  \textbf{package} & \textbf{relative} & \textbf{#1.000x} \\ 
  \hline
  options & \relative{#3} & \adjust[#1]{#3} \\
  pgfkeys & \relative{#4} & \adjust[#1]{#4} \\
  xkeyval & \relative{#5} & \adjust[#1]{#5} \\ \hline
  \end{tabular}\\[1ex]
  {baseline = \baseline ms} \\
  {platform = #7}\\
}

\newcommand\showresults{%
  % output benchmark results 
  
  \gentable{710}{2637}{3422}{22482}%
           {simple}%
           {Intel Core i7 @ 2.8ghz, 4Gb, XeTeX 3.14159265-2.6-0.99991 (TeX Live 2014/W32TeX)}

  \gentable{710}{4061}{8642}{23237}%
           {one level search}%complex
           {Intel Core i7 @ 2.8ghz, 4Gb, XeTeX 3.14159265-2.6-0.99991 (TeX Live 2014/W32TeX)}
}

\ifoptionequal{/bench/style}{show}%
 {\showresults}%
 {\ifcase\option{/bench/library/@ord}\relax
    % baseline = nothing
    \typeout{baseline: do nothing}%
  \or
    \runtest{options}
  \or
    \runtest{pgfkeys}
  \or
    \runtest{xkeyval}
  \or
  \else
    \optionerror[/bench/library]{unknown library}
  \fi
 }%


\end{document}
