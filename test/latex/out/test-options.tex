\documentclass{book}
% generated by Madoko, version 0.9.5-beta
%mdk-data-line={1}

\usepackage{etoolbox}
\usepackage{xcolor}
\usepackage{graphicx}

\makeatletter
% --------------------------------------------------------
% 
% --------------------------------------------------------

% - defoptioncmd{/fam/key}[default]{code}
%
% - defoptionfamily: {fam}{delegates}
% - defoptionstyle:  code on new keys
% - defoptionvalue:  {/fam/key}[default][initial]
% - defoptiontoggle: {/fam/key}[initial]
% - defoptiondimen:  {/fam/key}[initial]
% - defoptionchoice: {/fam/key}{choices}
% - defoptioncolor:  {/fam/key}[initial]
%
% - optionsreset{names}         : set back to original values
% - optionsset{options}\<name>  : process options, and set \<name> to the processed options
% - optionssetalso{options}     : used inside optionsset
%
% - option{/fam/key}: return the value 
% - letoption{/fam/key}\<name>
% - ifoptionequals
% - ifoptionblank

\def\optioncmd#1{\csname opt@key@#1\endcsname}
\def\option#1{\csname opt@val@#1\endcsname}

\def\setkeys#1{%
  \def\opt@family{}%
  \def\opt@delegates{}%
  \def\opt@prefix{}%
  \opt@do#1,\relax,}

\def\opt@do#1,{%
 \ifx\relax#1\empty\else
  \opt@split#1==\relax
  \expandafter\opt@do\fi}

\def\opt@split#1=#2=#3\relax{%
  \opt@@sp@def\@tempa{#1}%
  \ifx\@tempa\@empty\else
    \def\option@key{\@tempa}%
    \expandafter\let\expandafter\@tempc
      \csname optk@\@tempa\endcsname
    \ifx\@tempc\relax
      \ifoptiondefined{/\opt@family/.search}{%
        \option{/\opt@family/.search}%
      }{}%
    \fi  
    \ifx\@tempc\relax
      \opt@err{\@tempa\space is undefined in family "/\opt@family" (\opt@delegates)}%
    \else
      \ifx\@empty#3\@empty
        \option@assign@\option@key[\opt@default]
      \else
        \opt@@sp@def\@tempb{#2}%
        %\expandafter\@tempc\expandafter{\@tempb}\relax
        \option@assign@\option@key[\@tempb]%
      \fi
    \fi
  \fi}

\def\opt@searchdelegates{%
  \option{/\opt@family/.search}%
}

\def\opt@ondefault{%
  \expandafter\let\expandafter\@tempb\csname\@tempa/.default\endcsname
  \ifx\@tempb\relax
    \opt@err{No value specified for \@tempa}%
  \else
    \@tempb\relax
  \fi}

\def\opt@err#1{\errmessage{options: #1}}
\def\@tempa#1{%
\def\opt@@sp@def##1##2{\opt@@sp@b##2\@nil\@nil#1\@nil\relax##1}}
\@tempa{ }
\def\opt@@sp@b#1#2 \@nil{\opt@@sp@c#1#2}
\def\opt@@sp@c#1\@nil#2\relax#3{\def#3{#1}}

\def\defoption@cmd#1{%
  \@ifnextchar[{\opt@def{#1}}{\@namedef{optk@#1}####1}}

\def\opt@def#1[#2]{%
  \@namedef{optk@#1/.default\expandafter}\expandafter
    {\csname optk@#1\endcsname{#2}}%
  \@namedef{optk@#1}##1}


\makeatother

\begin{document}

\makeatletter

\def\opt@default{}

\def\opt@swap#1#2{#2{#1}}
\def\opt@expandarg#1#2{\expandafter\opt@swap\expandafter{#2}{#1}}

\def\option#1{\csname optk@#1\endcsname}
\def\letoption#1#2{\expandafter\let\expandafter#2\csname optk@#1\endcsname}

\def\option@setkey#1#2{\expandafter\def\csname optk@#1\endcsname{#2}}
\def\option@let#1#2{\cslet{optk@#1}#2}
\def\ifoptiondefined#1{\ifcsdef{optk@#1}}
\def\ifoptionvoid#1{\ifcsvoid{optk@#1}}

\def\eletoption#1#2{\letoption{#1}#2\edef#2{#2}}
\def\option@expand#1{\protected@edef\reserved@a{\option{#1}}\option@let{#1}\reserved@a}

\def\option@append#1#2{\ifoptiondefined{#1}{\csappto{optk@#1}}{\option@setkey{#1}}{#2}}
\def\option@prepend#1#2{\ifoptiondefined{#1}{\cspreto{optk@#1}}{\option@setkey{#1}}{#2}}
\def\option@appendlist#1#2{\ifoptionvoid{#1}{\option@setkey{#1}{#2}}{\csappto{optk@#1}{,#2}}}
\def\option@eappend#1#2{\opt@expandarg{\option@append{#1}}{#2}}

\def\option@assign#1{\def\option@key{#1}\@testopt{\option@assign@#1}\opt@default}
\def\option@assign@#1[#2]{%
  \ifoptiondefined{#1/.code}%
    {\ifx\opt@default#2\opt@default \let\option@value\opt@default\else\def\option@value{#2}\fi
     \option{#1/.code}{#2}}%
    {\ifx\opt@default#2\opt@default
        \ifoptiondefined{#1/.default}%
          {\option@setkey{#1}{\option{#1/.default}}}%
          {\opt@err{option #1 requires a value}}%
      \else
        \option@setkey{#1}{#2}%
      \fi
    }%   
}
\def\option@checkdefault{%
  \ifx\option@value\opt@default
    \ifoptiondefined{\option@key/.default}%
      {\letoption{\option@key/.default}\option@value}%
      {\opt@err{option \option@key requires a value}}%
  \fi
}%   
\def\option@checknoarg{%
  \ifx\option@value\opt@default\else
    \opt@err{option \option@key does not take an argument (\option@value)}%
  \fi
}%   
\def\option@settoarg{%
  \option@setkey{\option@key}{\option@value}%
}%   


\newcommand\defoptioncode[2]{%
  \csdef{optk@#1/.code}##1{%
    \typeout{invoke #1=##1 (\option@key=\option@value)}%
    #2%
  }%
  \csletcs{optk@#1}{optk@#1/.code}%
}
\newcommand\defoptionvalue[2]{%
  \typeout{define option: #1=#2}%
  \option@setkey{#1}{#2}%
  \option@setkey{#1/.initial}{#2}%
  \@ifnextchar[{\opt@setdefault{#1}}{}%  
}
\def\opt@setdefault#1[#2]{\option@setkey{#1/.default}{#2}}

\def\option@search#1#2{%
  \option@append{/#1/.search}{%
    \ifx\@tempc\relax \option{/#2/.search}\fi%
  }%
}

\newcommand\defoptionfamily[2][]{%
  \typeout{define family: #2: #1}%
  \defoptionvalue{/families/#2}{}%
  \def\do##1{%
    \ifoptiondefined{/families/##1}{%
      \option@appendlist{/families/#2}{##1}%
      \ifoptionvoid{/families/##1}{}%
        {\option@appendlist{/families/#2}{\option{/families/##1}}}%
    }{\opt@err{family definition "#2" refers to undefined family "##1" in its delegates}}%
  }%
  \docsvlist{#1}%
  \option@setkey{/#2/.search}{%
    \typeout{try: /#2/\@tempa}%
    \expandafter\let\expandafter\@tempc
      \csname optk@/#2/\@tempa\endcsname
    \ifx\@tempc\relax\else%
      \typeout{ found!}%
      \def\option@key{/#2/\@tempa}%
      \let\opt@next\@firstoftwo%
    \fi
  }%
  \def\do##1{%
    \option@search{#2}{##1}%
  }
  \docsvlist{#1}%
  \option@expand{/families/#2}%
  \typeout{  delegates: \option{/families/#2}}%
  \defoptioncode{/#2}{%
    \typeout{family code}%
    \option@checknoarg%
    \def\opt@family{#2}%
    \def\opt@prefix{/#2/}%
    \letoption{/families/#2}\opt@delegates
  }%
}


\defoptionfamily{fama}
\defoptionfamily[fama]{famb}
\defoptionfamily[fama]{famc}
\defoptionfamily[famb,famc]{fam}
\defoptioncode{/fama/test}{some test code}

\setkeys{/fam,test} nice.

\end{document}
