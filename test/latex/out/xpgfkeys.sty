%---------------------------------------------------------------------------
%  Copyright 2013 Microsoft Corporation.
% 
%  This is free software; you can redistribute it and/or modify it under the
%  terms of the Apache License, Version 2.0. A copy of the License can be
%  found in the file "license.txt" at the root of this distribution.
%---------------------------------------------------------------------------
\NeedsTeXFormat{LaTeX2e}[1995/12/01]

\RequirePackage{etoolbox}
\RequirePackage{xcolor}
\RequirePackage{pgfkeys}
\RequirePackage{enumitem}

% --------------------------------------------------------
% Extensions to etoolbox
% --------------------------------------------------------

\providerobustcmd*\@swaparg[2]{#2{#1}}
\providerobustcmd*\expandnext[2]{\expandafter\@swaparg\expandafter{#2}{#1}}

\providecommand\eifstrequal[1]{%
  \expandnext\ifstrequal{#1}%
}

\providecommand\eifblank[1]{%
  \expandnext\ifblank{#1}%
}

\providecommand\ontoggle[2]{%
  \iftoggle{#1}{#2}{}%
}

\providecommand\providelength[1]{% 
  \ifdef{#1}{}{\newlength#1}%
}

\providecommand\csnewlength[1]{%
  \expandafter\newlength\csname #1\endcsname%
}
\providecommand\csprovidelength[1]{%
  \ifcsdef{#1}{}{\expandafter\newlength\csname #1\endcsname}%
}
\providecommand\cssetlength[2]{%
  \expandafter\setlength\csname #1\endcsname{#2}%
}

% --------------------------------------------------------
%  get the pgf key prefix (=pgfk@)
% --------------------------------------------------------
\edef\pgfprefix{\expandafter\expandafter\expandafter\string\pgfkeysvalueof{}}
\edef\pgfprefix{\expandafter\@gobble\pgfprefix}%


% --------------------------------------------------------
% Basic commands in terms of values
% --------------------------------------------------------

\newcommand*\valueof{}
\let\valueof\pgfkeysvalueof
\newrobustcmd*\letvalue[2]{\pgfkeysgetvalue{#1}#2}%
\newrobustcmd*\edefvalue[2]{\letvalue{#1}#2\protected@edef#2{#2}}

\newcommand*\value@set{}
\let\value@set\pgfkeyssetvalue
\newrobustcmd*\value@eset[2]{\expandnext{\value@set{#1}}{#2}}
\newrobustcmd*\value@xset[2]{\protected@edef\xpk@temp{#2}\value@eset{#1}{\xpk@temp}}
\newrobustcmd*\value@append[2]{\csappto{\pgfprefix#1}{#2}}
\newrobustcmd*\value@eappend[2]{\ecsappto{\pgfprefix#1}{#2}}

\providecommand\ifvalueblank[1]{%
  \edefvalue{#1}\xpk@temp%
  \expandafter\ifblank\expandafter{\xpk@temp}%
}
\providecommand\ifvalueequal[1]{%
  \edefvalue{#1}\xpk@temp%
  \expandafter\ifstrequal\expandafter{\xpk@temp}%
}

% short hands
\let\setvalues\pgfkeys
\let\defvalues\pgfkeys
\let\setvaluesalso\pgfkeysalso


% test if a key is not defined, or blank
\providecommand\ifvaluevoid[1]{%
  \ifcsvoid{\pgfprefix#1}%
}

% test if a key is a macro with a parameter
\providecommand\ifvaluecmd[1]{%
  \ifcsparam{\pgfprefix#1}%
}

\newcommand*\ifvaluedefined{}
\let\ifvaluedefined\pgfkeysifdefined



% --------------------------------------------------------
% Comma seperated values
% --------------------------------------------------------

\newrobustcmd*\xpk@headof[1]{\xpk@headof@#1,\relax}%
\def\xpk@headof@#1,#2\relax{#1}%

\providerobustcmd*\ifanyof[2]{%
  \let\do@next\@secondoftwo
  \edef\xpk@temp{#1}%
  \def\do##1{\eifstrequal{\xpk@temp}{##1}{\let\do@next\@firstoftwo\listbreak}{}}%
  \expandnext\docsvlist{#2}%
  \do@next
}

\providerobustcmd*\ifvalueanyof[2]{%
  \ifanyof{\valueof{#1}}{#2}%
}

% --------------------------------------------------------
% List values
% --------------------------------------------------------

\newrobustcmd*\value@setnil[1]{\value@set{#1}{}}
\newrobustcmd*\value@push[2]{\listcsadd{\pgfprefix#1}{#2}}
\newrobustcmd*\value@epush[2]{\listcseadd{\pgfprefix#1}{#2}}%
\newrobustcmd*\valuelistdo[2]{\def\xpk@@do##1{#2}\forlistcsloop{\xpk@@do}{\pgfprefix#1}}

\newrobustcmd*\value@setlist[2]{%
  \value@setnil{#1}\value@concat{#1}{#2}%
}
\newrobustcmd*\value@concat[2]{%
  \def\do##1{\value@epush{#1}{##1}}%
  \expandnext\docsvlist{#2}%
}
\newrobustcmd*\letvaluelist[2]{%
  \def#2{}%
  \valuelistdo{#1}{%
    \ifdefempty#2%
      {\def#2{##1}}%
      {\appto#2{,##1}}%
  }%
}
\newrobustcmd*\ifvaluecontains[2]{%
  \xifinlistcs{#2}{\pgfprefix#1}%
}

\let\ifvaluenil\ifvaluevoid



% --------------------------------------------------------
% Call xpk@newvaluekey when defining 'value' keys
% This registers keys in metadata so they can be displayed
% Also sets the more stable "xpk@currentpath" to be
% used when defining extra values
% --------------------------------------------------------

\newrobustcmd*\xpk@newvaluekey[1][\pgfkeyscurrentpath]{%
  \edef\xpk@currentpath{#1}%
  \edef\pgfkeyscurrentkey{#1}%
  \xpk@newvaluekey@{/.@names}%
}
\newrobustcmd*\xpk@newvaluekey@[1]{%
  \eifblank{\pgfkeyscurrentkey}{}{%
    \pgfkeys@split@path
    \edef\xpk@tempname{/@meta/keys\pgfkeyscurrentpath}%
    \ifvaluedefined{\xpk@tempname/.@names}{}{%
      \value@setnil{\xpk@tempname/.@names}%
      \value@setnil{\xpk@tempname/.@paths}%
    }%
    \ifvaluecontains{\xpk@tempname#1}{\pgfkeyscurrentname}%
      {}{\value@epush{\xpk@tempname#1}{\pgfkeyscurrentname}}%
    \letvaluelist{\xpk@tempname#1}\xpk@list%
    %\typeout{new list: \xpk@list, added \pgfkeyscurrentname}%
    \edef\pgfkeyscurrentkey{\pgfkeyscurrentpath}%
    \xpk@newvaluekey@{/.@paths}%
  }%
}



% --------------------------------------------------------
% Show definitions
% --------------------------------------------------------

\newrobustcmd*\showvalues{%
  \showvaluesinpath{}%
}

\newrobustcmd*\showvaluesinpath[1]{%
  \xpk@showpath{}{#1}%
}

\newrobustcmd*\xpk@showpath[2]{%  
  \noindent\xpk@fontpath{#2/}%
  \xpk@showitems{#1#2}{/.@names}{\xpk@showname}%
  \xpk@showitems{#1#2}{/.@paths}{\xpk@showpath}%
}

\newrobustcmd*\xpk@showitems[4][]{%
  \ifvaluenil{/@meta/keys#2#3}{}{%
    \begin{itemize}[noitemsep,topsep=0pt,leftmargin=1em,label=,#1]
    \valuelistdo{/@meta/keys#2#3}{%
      \item\noindent#4{#2/}{##1}%
    }%
    \end{itemize}
  }%
}

\newrobustcmd*\xpk@showname[2]{%
  \xpk@fontname{#2}%
  =\valueshow{#1#2}%
  \ifvaluedefined{#1#2/.@initial}{%
    , initial=\valueshowliteral{#1#2/.@initial}%
  }{}%
  \ifvaluedefined{#1#2/.@def}{%
    , default=\valueshowliteral{#1#2/.@def}%
  }{}%
}

\newrobustcmd*\valueshowliteral[1]{%
  \letvalue{#1}\xpk@temp\texttt{\expandnext\detokenize{\xpk@temp}}%
}

\newrobustcmd*\valueshow[1]{%
  \ifvaluedefined{#1/.@show}%
    {\xpk@fontvalue{\valueof{#1/.@show}{#1}}}%
    {\ifvaluecmd{#1}%
      {\xpk@fontspecial{cmd}}%
      {\xpk@fontvalue{\valueof{#1}}}}%
}

\newrobustcmd*\xpk@fontname[1]{\textsf{#1}}
\newrobustcmd*\xpk@fontpath[1]{\textsf{#1}}
\newrobustcmd*\xpk@fontvalue[1]{\textsf{#1}}
\newrobustcmd*\xpk@fontspecial[1]{\textit{#1}}


% --------------------------------------------------------
% 
% --------------------------------------------------------

\newrobustcmd*\xpk@initdefault{\@ifnextchar[{\xpk@initdefault@def}{\xpk@initdefault@init}}
\def\xpk@initdefault@def[#1]{%
  \pgfkeysalso{\pgfkeyscurrentpath/.default=#1}%
  \xpk@initdefault@init
}
\def\xpk@initdefault@init#1\relax{%
  \value@set{\pgfkeyscurrentpath/.@initial}{#1}%
  \ifvaluedefined{\pgfkeyscurrentpath/.@cmd}%
    {\pgfkeysalso{\pgfkeyscurrentpath={#1}}}%
    {\value@set{\pgfkeyscurrentpath}{#1}}%
}



% --------------------------------------------------------
% 
% --------------------------------------------------------

\pgfkeysdef{/handlers/.set show}{%
  \def\xpk@show##1{#1}%
  \pgfkeyslet{\pgfkeyscurrentpath/.@show}\xpk@show%
}

\pgfkeysdef{/handlers/.einitial}{%
  \value@xset{\pgfkeyscurrentpath}{#1}%
}

\newrobustcmd\newvaluetype[2]{%
  \csdef{xpk@create@#1}##1##2{\pgfqkeysalso{##2}{#2}}%
  \pgfkeysdef{/handlers/.new #1}{%
    \typeout{create #1: \pgfkeyscurrentpath = ##1}%
    \edef\xpk@valuepath{\pgfkeyscurrentpath}%
    \xpk@newvaluekey%
    \expandnext{\csuse{xpk@create@#1}{##1}}{\xpk@valuepath}%
  } 
}
\newrobustcmd\newvalue@[2]{%
  \pgfqkeysalso{\xpk@currentpath}{%
    #2{#1}%
  }
}

\pgfkeysdef{/handlers/.init}{%
  \xpk@initdefault#1\relax%
}

\pgfkeysdef{/handlers/.exec}{%
  #1%
}



\newvaluetype{family}{%
  .is family,
  .search also=#1,
}


\newvaluetype{value}{%
  .init=#1,
}

\newvaluetype{length}{%
  .exec     =\csnewlength{length@#2},%
  .einitial =\csuse{length@#2},%
  .code     =\cssetlength{length@#2}{\dimexpr##1\relax},%
  .set show =\the\valueof{##1},%
  .init     =#1,
}

\newvaluetype{dimen}{%
  .initial  =\dimexpr\valueof{#2/.@dimen}\relax,%
  .code     =\value@set{#2/.@dimen}{##1},%
  .set show ={\the\valueof{##1} (=\valueshowliteral{##1/.@dimen})},%
  .init     =#1,
}


